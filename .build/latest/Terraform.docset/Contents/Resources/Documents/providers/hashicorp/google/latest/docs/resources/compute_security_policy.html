<html><!-- Online page at https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_security_policy --><head>
                <title>google_compute_security_policy</title>
                <meta charset="utf-8"/>
                <link href="../../../../../../style.css" rel="stylesheet"/>
            </head>
            <body>
                <h1 id="google_compute_security_policy">google_compute_security_policy</h1>

<p>A Security Policy defines an IP blacklist or whitelist that protects load balanced Google Cloud services by denying or permitting traffic from specified IP ranges. For more information
see the <a href="https://cloud.google.com/armor/docs/configure-security-policies">official documentation</a>
and the <a href="https://cloud.google.com/compute/docs/reference/rest/beta/securityPolicies">API</a>.</p>

<p>Security Policy is used by <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_backend_service#security_policy"><code>google_compute_backend_service</code></a>.</p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage"></a><h2 id="example-usage">Example Usage</h2>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"google_compute_security_policy"</span><span class="w"> </span><span class="nv">"policy"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-policy"</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"deny(403)"</span><span class="w"></span>
<span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1000"</span><span class="w"></span>
<span class="w">    </span><span class="nb">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">versioned_expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SRC_IPS_V1"</span><span class="w"></span>
<span class="w">      </span><span class="nb">config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">src_ip_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"9.9.9.0/24"</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Deny access to IPs in 9.9.9.0/24"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"allow"</span><span class="w"></span>
<span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2147483647"</span><span class="w"></span>
<span class="w">    </span><span class="nb">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">versioned_expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SRC_IPS_V1"</span><span class="w"></span>
<span class="w">      </span><span class="nb">config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">src_ip_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"*"</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"default rule"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20With%20reCAPTCHA%20configuration%20options"></a><h2 id="example-usage-with-recaptcha-configuration-options">Example Usage - With reCAPTCHA configuration options</h2>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"google_recaptcha_enterprise_key"</span><span class="w"> </span><span class="nv">"primary"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"display-name"</span><span class="w"></span>

<span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">label-one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value-one"</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>

<span class="w">  </span><span class="nb">web_settings</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">integration_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"INVISIBLE"</span><span class="w"></span>
<span class="w">    </span><span class="na">allow_all_domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">allowed_domains</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"localhost"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_compute_security_policy"</span><span class="w"> </span><span class="nv">"policy"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-policy"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"basic security policy"</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"CLOUD_ARMOR"</span><span class="w"></span>

<span class="w">  </span><span class="nb">recaptcha_options_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">redirect_site_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_recaptcha_enterprise_key.primary.name</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20With%20header%20actions"></a><h2 id="example-usage-with-header-actions">Example Usage - With header actions</h2>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"google_compute_security_policy"</span><span class="w"> </span><span class="nv">"policy"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-policy"</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"allow"</span><span class="w"></span>
<span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2147483647"</span><span class="w"></span>
<span class="w">    </span><span class="nb">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">versioned_expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SRC_IPS_V1"</span><span class="w"></span>
<span class="w">      </span><span class="nb">config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">src_ip_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"*"</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"default rule"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"allow"</span><span class="w"></span>
<span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1000"</span><span class="w"></span>
<span class="w">    </span><span class="nb">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">expr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"request.path.matches(\"/login.html\") &amp;&amp; token.recaptcha_session.score &lt; 0.2"</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">header_action</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">request_headers_to_adds</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">header_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"reCAPTCHA-Warning"</span><span class="w"></span>
<span class="w">        </span><span class="na">header_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"high"</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="nb">request_headers_to_adds</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">header_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"X-Resource"</span><span class="w"></span>
<span class="w">        </span><span class="na">header_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20With%20enforceOnKey%20value%20as%20empty%20string"></a><h2 id="example-usage-with-enforceonkey-value-as-empty-string">Example Usage - With enforceOnKey value as empty string</h2>

<p>A scenario example that won't cause any conflict between <code>enforce_on_key</code> and <code>enforce_on_key_configs</code>, because <code>enforce_on_key</code> was specified as an empty string:</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"google_compute_security_policy"</span><span class="w"> </span><span class="nv">"policy"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"%s"</span><span class="w"></span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"throttle rule with enforce_on_key_configs"</span><span class="w"></span>

<span class="w">    </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"throttle"</span><span class="w"></span>
<span class="w">        </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2147483647"</span><span class="w"></span>
<span class="w">        </span><span class="nb">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="na">versioned_expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SRC_IPS_V1"</span><span class="w"></span>
<span class="w">            </span><span class="nb">config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="na">src_ip_ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"*"</span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"default rule"</span><span class="w"></span>

<span class="w">        </span><span class="nb">rate_limit_options</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="na">conform_action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"allow"</span><span class="w"></span>
<span class="w">            </span><span class="na">exceed_action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"redirect"</span><span class="w"></span>

<span class="w">            </span><span class="na">enforce_on_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w"></span>

<span class="w">            </span><span class="nb">enforce_on_key_configs</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="na">enforce_on_key_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"IP"</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">exceed_redirect_options</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"EXTERNAL_302"</span><span class="w"></span>
<span class="w">                </span><span class="na">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;https://www.example.com&gt;"</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="nb">rate_limit_threshold</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
<span class="w">                </span><span class="na">interval_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Argument%20Reference"></a><h2 id="argument-reference">Argument Reference</h2>

<p>The following arguments are supported:</p>

<ul>
<li><code>name</code> - (Required) The name of the security policy.</li>
</ul>

<hr/>

<ul>
<li><p><code>description</code> - (Optional) An optional description of this security policy. Max size is 2048.</p></li>
<li><p><code>project</code> - (Optional) The project in which the resource belongs. If it
is not provided, the provider project is used.</p></li>
<li><p><code>rule</code> - (Optional) The set of rules that belong to this policy. There must always be a default
rule (rule with priority 2147483647 and match "*"). If no rules are provided when creating a
security policy, a default rule with action "allow" will be added. Structure is <a href="#nested_rule">documented below</a>.</p></li>
<li><p><code>advanced_options_config</code> - (Optional) <a href="https://cloud.google.com/armor/docs/security-policy-overview#json-parsing">Advanced Configuration Options</a>.
Structure is <a href="#nested_advanced_options_config">documented below</a>.</p></li>
<li><p><code>adaptive_protection_config</code> - (Optional) Configuration for <a href="https://cloud.google.com/armor/docs/adaptive-protection-overview?hl=en">Google Cloud Armor Adaptive Protection</a>. Structure is <a href="#nested_adaptive_protection_config">documented below</a>.</p></li>
<li><p><code>recaptcha_options_config</code> - (Optional) <a href="https://cloud.google.com/armor/docs/configure-security-policies?hl=en#use_a_manual_challenge_to_distinguish_between_human_or_automated_clients">reCAPTCHA Configuration Options</a>. Structure is <a href="#nested_recaptcha_options_config">documented below</a>.</p></li>
<li><p><code>type</code> - The type indicates the intended use of the security policy. This field can be set only at resource creation time.</p>

<ul>
<li><code>CLOUD_ARMOR</code> - Cloud Armor backend security policies can be configured to filter incoming HTTP requests targeting backend services.
They filter requests before they hit the origin servers.</li>
<li><code>CLOUD_ARMOR_EDGE</code> - Cloud Armor edge security policies can be configured to filter incoming HTTP requests targeting backend services
(including Cloud CDN-enabled) as well as backend buckets (Cloud Storage).
They filter requests before the request is served from Google's cache.</li>
<li><code>CLOUD_ARMOR_INTERNAL_SERVICE</code> - Cloud Armor internal service policies can be configured to filter HTTP requests targeting services
managed by Traffic Director in a service mesh. They filter requests before the request is served from the application.</li>
</ul></li>
</ul>

<p><a name="nested_advanced_options_config"></a>The <code>advanced_options_config</code> block supports:</p>

<ul>
<li><p><code>json_parsing</code> - Whether or not to JSON parse the payload body. Defaults to <code>DISABLED</code>.</p>

<ul>
<li><code>DISABLED</code> - Don't parse JSON payloads in POST bodies.</li>
<li><code>STANDARD</code> - Parse JSON payloads in POST bodies.</li>
<li><code>STANDARD_WITH_GRAPHQL</code> - Parse JSON and GraphQL payloads in POST bodies.</li>
</ul></li>
<li><p><code>json_custom_config</code> - Custom configuration to apply the JSON parsing. Only applicable when
<code>json_parsing</code> is set to <code>STANDARD</code>. Structure is <a href="#nested_json_custom_config">documented below</a>.</p></li>
<li><p><code>log_level</code> - Log level to use. Defaults to <code>NORMAL</code>.</p>

<ul>
<li><code>NORMAL</code> - Normal log level.</li>
<li><code>VERBOSE</code> - Verbose log level.</li>
</ul></li>
<li><p><code>user_ip_request_headers</code> - (Optional) An optional list of case-insensitive request header names to use for resolving the callers client IP address.</p></li>
</ul>

<p><a name="nested_json_custom_config"></a>The <code>json_custom_config</code> block supports:</p>

<ul>
<li><code>content_types</code> - A list of custom Content-Type header values to apply the JSON parsing. The
format of the Content-Type header values is defined in
<a href="https://www.ietf.org/rfc/rfc1341.txt">RFC 1341</a>. When configuring a custom Content-Type header
value, only the type/subtype needs to be specified, and the parameters should be excluded.</li>
</ul>

<p><a name="nested_rule"></a>The <code>rule</code> block supports:</p>

<ul>
<li><p><code>action</code> - (Required) Action to take when <code>match</code> matches the request. Valid values:</p>

<ul>
<li><code>allow</code>: allow access to target.</li>
<li><code>deny()</code>: deny access to target, returns the HTTP response code specified (valid values are 403, 404, and 502).</li>
<li><code>rate_based_ban</code>: limit client traffic to the configured threshold and ban the client if the traffic exceeds the threshold. Configure parameters for this action in <a href="#nested_rate_limit_options"><code>rate_limit_options</code></a>. Requires <a href="#nested_rate_limit_options"><code>rate_limit_options</code></a> to be set.</li>
<li><code>redirect</code>: redirect to a different target. This can either be an internal reCAPTCHA redirect, or an external URL-based redirect via a 302 response. Parameters for this action can be configured via <a href="#nested_redirect_options"><code>redirect_options</code></a>.</li>
<li><code>throttle</code>: limit client traffic to the configured threshold. Configure parameters for this action in <a href="#nested_rate_limit_options"><code>rate_limit_options</code></a>. Requires <a href="#nested_rate_limit_options"><code>rate_limit_options</code></a> to be set for this.</li>
</ul></li>
<li><p><code>priority</code> - (Required) An unique positive integer indicating the priority of evaluation for a rule.
Rules are evaluated from highest priority (lowest numerically) to lowest priority (highest numerically) in order.</p></li>
<li><p><code>match</code> - (Required) A match condition that incoming traffic is evaluated against.
If it evaluates to true, the corresponding <code>action</code> is enforced. Structure is <a href="#nested_match">documented below</a>.</p></li>
<li><p><code>preconfigured_waf_config</code> - (Optional) Preconfigured WAF configuration to be applied for the rule. If the rule does not evaluate preconfigured WAF rules, i.e., if <code>evaluatePreconfiguredWaf()</code> is not used, this field will have no effect. Structure is <a href="#nested_preconfigured_waf_config">documented below</a>.</p></li>
<li><p><code>description</code> - (Optional) An optional description of this rule. Max size is 64.</p></li>
<li><p><code>preview</code> - (Optional) When set to true, the <code>action</code> specified above is not enforced.
Stackdriver logs for requests that trigger a preview action are annotated as such.</p></li>
<li><p><code>rate_limit_options</code> - (Optional)
Must be specified if the <code>action</code> is <code>rate_based_ban</code> or <code>throttle</code>. Cannot be specified for other actions. Structure is <a href="#nested_rate_limit_options">documented below</a>.</p></li>
<li><p><code>redirect_options</code> - (Optional)
Can be specified if the <code>action</code> is <code>redirect</code>. Cannot be specified for other actions. Structure is <a href="#nested_redirect_options">documented below</a>.</p></li>
<li><p><code>header_action</code> - (Optional)
Additional actions that are performed on headers. Structure is <a href="#nested_header_action">documented below</a>.</p></li>
</ul>

<p><a name="nested_match"></a>The <code>match</code> block supports:</p>

<ul>
<li><p><code>config</code> - (Optional) The configuration options available when specifying <code>versioned_expr</code>.
This field must be specified if <code>versioned_expr</code> is specified and cannot be specified if <code>versioned_expr</code> is not specified.
Structure is <a href="#nested_config">documented below</a>.</p></li>
<li><p><code>versioned_expr</code> - (Optional) Predefined rule expression. If this field is specified, <code>config</code> must also be specified.
Available options:</p>

<ul>
<li><code>SRC_IPS_V1</code>: Must specify the corresponding <code>src_ip_ranges</code> field in <code>config</code>.</li>
</ul></li>
<li><p><code>expr</code> - (Optional) User defined CEVAL expression. A CEVAL expression is used to specify match criteria
such as <code>origin.ip</code>, <code>source.region_code</code> and <code>contents</code> in the request header.
Structure is <a href="#nested_expr">documented below</a>.</p></li>
<li><p><code>expr_options</code> -
(Optional)
The configuration options available when specifying a user defined CEVAL expression (i.e., 'expr').
Structure is <a href="#nested_expr_options">documented below</a>.</p></li>
</ul>

<p><a name="nested_config"></a>The <code>config</code> block supports:</p>

<ul>
<li><code>src_ip_ranges</code> - (Required) Set of IP addresses or ranges (IPV4 or IPV6) in CIDR notation
to match against inbound traffic. There is a limit of 10 IP ranges per rule. A value of <code>*</code> matches all IPs
(can be used to override the default behavior).</li>
</ul>

<p><a name="nested_expr"></a>The <code>expr</code> block supports:</p>

<ul>
<li><code>expression</code> - (Required) Textual representation of an expression in Common Expression Language syntax.
The application context of the containing message determines which well-known feature set of CEL is supported.</li>
</ul>

<p><a name="nested_expr_options"></a>The <code>expr_options</code> block supports:</p>

<ul>
<li><code>recaptcha_options</code> -
(Required)
reCAPTCHA configuration options to be applied for the rule. If the rule does not evaluate reCAPTCHA tokens, this field has no effect.
Structure is <a href="#nested_recaptcha_options">documented below</a>.</li>
</ul>

<p><a name="nested_recaptcha_options"></a>The <code>recaptcha_options</code> block supports:</p>

<ul>
<li><p><code>action_token_site_keys</code> -
(Optional)
A list of site keys to be used during the validation of reCAPTCHA action-tokens. The provided site keys need to be created from reCAPTCHA API under the same project where the security policy is created.</p></li>
<li><p><code>session_token_site_keys</code> -
(Optional)
A list of site keys to be used during the validation of reCAPTCHA session-tokens. The provided site keys need to be created from reCAPTCHA API under the same project where the security policy is created.</p></li>
</ul>

<p><a name="nested_preconfigured_waf_config"></a>The <code>preconfigured_waf_config</code> block supports:</p>

<ul>
<li><code>exclusion</code> - (Optional) An exclusion to apply during preconfigured WAF evaluation. Structure is <a href="#nested_exclusion">documented below</a>.</li>
</ul>

<p><a name="nested_exclusion"></a>The <code>exclusion</code> block supports:</p>

<ul>
<li><p><code>request_header</code> - (Optional) Request header whose value will be excluded from inspection during preconfigured WAF evaluation. Structure is <a href="#nested_field_params">documented below</a>.</p></li>
<li><p><code>request_cookie</code> - (Optional) Request cookie whose value will be excluded from inspection during preconfigured WAF evaluation. Structure is <a href="#nested_field_params">documented below</a>.</p></li>
<li><p><code>request_uri</code> - (Optional) Request URI from the request line to be excluded from inspection during preconfigured WAF evaluation. When specifying this field, the query or fragment part should be excluded. Structure is <a href="#nested_field_params">documented below</a>.</p></li>
<li><p><code>request_query_param</code> - (Optional) Request query parameter whose value will be excluded from inspection during preconfigured WAF evaluation. Note that the parameter can be in the query string or in the POST body. Structure is <a href="#nested_field_params">documented below</a>.</p></li>
<li><p><code>target_rule_set</code> - (Required) Target WAF rule set to apply the preconfigured WAF exclusion.</p></li>
<li><p><code>target_rule_ids</code> - (Optional) A list of target rule IDs under the WAF rule set to apply the preconfigured WAF exclusion. If omitted, it refers to all the rule IDs under the WAF rule set.</p></li>
</ul>

<p><a name="nested_field_params"></a>The <code>request_header</code>, <code>request_cookie</code>, <code>request_uri</code> and <code>request_query_param</code> blocks support:</p>

<ul>
<li><p><code>operator</code> - (Required) You can specify an exact match or a partial match by using a field operator and a field value.</p>

<ul>
<li><code>EQUALS</code>: The operator matches if the field value equals the specified value.</li>
<li><code>STARTS_WITH</code>: The operator matches if the field value starts with the specified value.</li>
<li><code>ENDS_WITH</code>: The operator matches if the field value ends with the specified value.</li>
<li><code>CONTAINS</code>: The operator matches if the field value contains the specified value.</li>
<li><code>EQUALS_ANY</code>: The operator matches if the field value is any value.</li>
</ul></li>
<li><p><code>value</code> - (Optional) A request field matching the specified value will be excluded from inspection during preconfigured WAF evaluation.
The field value must be given if the field <code>operator</code> is not <code>EQUALS_ANY</code>, and cannot be given if the field <code>operator</code> is <code>EQUALS_ANY</code>.</p></li>
</ul>

<p><a name="nested_rate_limit_options"></a>The <code>rate_limit_options</code> block supports:</p>

<ul>
<li><p><code>conform_action</code> - (Required) Action to take for requests that are under the configured rate limit threshold. Valid option is <code>allow</code> only.</p></li>
<li><p><code>exceed_action</code> - (Required) When a request is denied, returns the HTTP response code specified.
Valid options are <code>deny()</code> where valid values for status are 403, 404, 429, and 502.</p></li>
<li><p><code>rate_limit_threshold</code> - (Required) Threshold at which to begin ratelimiting. Structure is <a href="#nested_threshold">documented below</a>.</p></li>
<li><p><code>ban_duration_sec</code> - (Optional) Can only be specified if the <code>action</code> for the rule is <code>rate_based_ban</code>.
If specified, determines the time (in seconds) the traffic will continue to be banned by the rate limit after the rate falls below the threshold.</p></li>
<li><p><code>ban_threshold</code> - (Optional) Can only be specified if the <code>action</code> for the rule is <code>rate_based_ban</code>.
If specified, the key will be banned for the configured <code>ban_duration_sec</code> when the number of requests that exceed the <code>rate_limit_threshold</code> also
exceed this <code>ban_threshold</code>. Structure is <a href="#nested_threshold">documented below</a>.</p></li>
<li><p><code>enforce_on_key</code> - (Optional) Determines the key to enforce the rate_limit_threshold on. If not specified, defaults to <code>ALL</code>.</p>

<ul>
<li><code>ALL</code>: A single rate limit threshold is applied to all the requests matching this rule.</li>
<li><code>IP</code>: The source IP address of the request is the key. Each IP has this limit enforced separately.</li>
<li><code>HTTP_HEADER</code>: The value of the HTTP header whose name is configured under <code>enforce_on_key_name</code>. The key value is truncated to the first 128 bytes of the header value. If no such header is present in the request, the key type defaults to <code>ALL</code>.</li>
<li><code>XFF_IP</code>: The first IP address (i.e. the originating client IP address) specified in the list of IPs under <code>X-Forwarded-For</code> HTTP header. If no such header is present or the value is not a valid IP, the key type defaults to <code>ALL</code>.</li>
<li><code>HTTP_COOKIE</code>: The value of the HTTP cookie whose name is configured under <code>enforce_on_key_name</code>. The key value is truncated to the first 128 bytes of the cookie value. If no such cookie is present in the request, the key type defaults to <code>ALL</code>.</li>
<li><code>HTTP_PATH</code>: The URL path of the HTTP request. The key value is truncated to the first 128 bytes</li>
<li><code>SNI</code>: Server name indication in the TLS session of the HTTPS request. The key value is truncated to the first 128 bytes. The key type defaults to <code>ALL</code> on a HTTP session.</li>
<li><code>REGION_CODE</code>: The country/region from which the request originates.</li>
<li><code>TLS_JA3_FINGERPRINT</code>: JA3 TLS/SSL fingerprint if the client connects using HTTPS, HTTP/2 or HTTP/3. If not available, the key type defaults to ALL.</li>
<li><code>USER_IP</code>: The IP address of the originating client, which is resolved based on "user_ip_request_headers" configured with the securitypolicy. If there is no "user_ip_request_headers" configuration or an IP address cannot be resolved from it, the key type defaults to IP.</li>
</ul></li>
<li><p><code>enforce_on_key_name</code> - (Optional) Rate limit key name applicable only for the following key types:</p>

<ul>
<li><code>HTTP_HEADER</code> -- Name of the HTTP header whose value is taken as the key value.</li>
<li><code>HTTP_COOKIE</code> -- Name of the HTTP cookie whose value is taken as the key value.</li>
</ul></li>
<li><p><code>enforce_on_key_configs</code> - (Optional, <a href="https://terraform.io/docs/providers/google/guides/provider_versions.html">Beta</a>) If specified, any combination of values of enforce_on_key_type/enforce_on_key_name is treated as the key on which rate limit threshold/action is enforced. You can specify up to 3 enforce_on_key_configs. If <code>enforce_on_key_configs</code> is specified, <code>enforce_on_key</code> must be set to an empty string. Structure is <a href="#nested_enforce_on_key_configs">documented below</a>.</p>

<p><strong>Note:</strong> To avoid the conflict between <code>enforce_on_key</code> and <code>enforce_on_key_configs</code>, the field <a href="#enforce_on_key"><code>enforce_on_key</code></a> needs to be set to an empty string.</p></li>
</ul>

<p><a name="nested_enforce_on_key_configs"></a>The <code>enforce_on_key_configs</code> block supports:</p>

<ul>
<li><p><code>enforce_on_key_name</code> - (Optional) Rate limit key name applicable only for the following key types:</p>

<ul>
<li><code>HTTP_HEADER</code> -- Name of the HTTP header whose value is taken as the key value.</li>
<li><code>HTTP_COOKIE</code> -- Name of the HTTP cookie whose value is taken as the key value.</li>
</ul></li>
<li><p><code>enforce_on_key_type</code> - (Optional) Determines the key to enforce the <code>rate_limit_threshold</code> on. If not specified, defaults to <code>ALL</code>.</p>

<ul>
<li><code>ALL</code>: A single rate limit threshold is applied to all the requests matching this rule.</li>
<li><code>IP</code>: The source IP address of the request is the key. Each IP has this limit enforced separately.</li>
<li><code>HTTP_HEADER</code>: The value of the HTTP header whose name is configured on <code>enforce_on_key_name</code>. The key value is truncated to the first 128 bytes of the header value. If no such header is present in the request, the key type defaults to <code>ALL</code>.</li>
<li><code>XFF_IP</code>: The first IP address (i.e. the originating client IP address) specified in the list of IPs under X-Forwarded-For HTTP header. If no such header is present or the value is not a valid IP, the key type defaults to <code>ALL</code>.</li>
<li><code>HTTP_COOKIE</code>: The value of the HTTP cookie whose name is configured under <code>enforce_on_key_name</code>. The key value is truncated to the first 128 bytes of the cookie value. If no such cookie is present in the request, the key type defaults to <code>ALL</code>.</li>
<li><code>HTTP_PATH</code>: The URL path of the HTTP request. The key value is truncated to the first 128 bytes</li>
<li><code>SNI</code>: Server name indication in the TLS session of the HTTPS request. The key value is truncated to the first 128 bytes. The key type defaults to <code>ALL</code> on a HTTP session.</li>
<li><code>REGION_CODE</code>: The country/region from which the request originates.</li>
<li><code>TLS_JA3_FINGERPRINT</code>: JA3 TLS/SSL fingerprint if the client connects using HTTPS, HTTP/2 or HTTP/3. If not available, the key type defaults to ALL.</li>
<li><code>USER_IP</code>: The IP address of the originating client, which is resolved based on "user_ip_request_headers" configured with the securitypolicy. If there is no "user_ip_request_headers" configuration or an IP address cannot be resolved from it, the key type defaults to IP.</li>
</ul></li>
<li><p><code>exceed_redirect_options</code> - (Optional) Parameters defining the redirect action that is used as the exceed action. Cannot be specified if the exceed action is not redirect. Structure is <a href="#nested_exceed_redirect_options">documented below</a>.</p></li>
</ul>

<p><a name="nested_threshold"></a>The <code>{ban/rate_limit}_threshold</code> block supports:</p>

<ul>
<li><p><code>count</code> - (Required) Number of HTTP(S) requests for calculating the threshold.</p></li>
<li><p><code>interval_sec</code> - (Required) Interval over which the threshold is computed.</p></li>
<li><p><a name="nested_exceed_redirect_options"></a>The <code>exceed_redirect_options</code> block supports:</p></li>
<li><p><code>type</code> - (Required) Type of the redirect action.</p></li>
<li><p><code>target</code> - (Optional) Target for the redirect action. This is required if the type is <code>EXTERNAL_302</code> and cannot be specified for <code>GOOGLE_RECAPTCHA</code>.</p></li>
</ul>

<p><a name="nested_redirect_options"></a>The <code>redirect_options</code> block supports:</p>

<ul>
<li><p><code>type</code> - (Required) Type of redirect action.</p>

<ul>
<li><code>EXTERNAL_302</code>: Redirect to an external address, configured in <code>target</code>.</li>
<li><code>GOOGLE_RECAPTCHA</code>: Redirect to Google reCAPTCHA.</li>
</ul></li>
<li><p><code>target</code> - (Optional) External redirection target when <code>EXTERNAL_302</code> is set in <code>type</code>.</p></li>
</ul>

<p><a name="nested_header_action"></a> The <code>header_action</code> block supports:</p>

<ul>
<li><code>request_headers_to_adds</code> - (Required) The list of request headers to add or overwrite if they're already present. Structure is <a href="#nested_request_headers_to_adds">documented below</a>.</li>
</ul>

<p><a name="nested_request_headers_to_adds"></a><a> The <code>request_headers_to_adds</code> block supports:</a></p><a>

<ul>
<li><p><code>header_name</code> - (Required) The name of the header to set.</p></li>
<li><p><code>header_value</code> - (Optional) The value to set the named header to.</p></li>
</ul>

</a><p><a></a><a name="nested_adaptive_protection_config"></a>The <code>adaptive_protection_config</code> block supports:</p>

<ul>
<li><p><code>layer_7_ddos_defense_config</code> - (Optional) Configuration for <a href="https://cloud.google.com/armor/docs/adaptive-protection-overview?hl=en">Google Cloud Armor Adaptive Protection Layer 7 DDoS Defense</a>. Structure is <a href="#nested_layer_7_ddos_defense_config">documented below</a>.</p></li>
<li><p><code>auto_deploy_config</code> - (Optional, <a href="https://terraform.io/docs/providers/google/guides/provider_versions.html">Beta</a>) Configuration for <a href="https://cloud.google.com/armor/docs/adaptive-protection-auto-deploy?hl=en">Automatically deploy Adaptive Protection suggested rules</a>. Structure is <a href="#nested_auto_deploy_config">documented below</a>.</p></li>
</ul>

<p><a name="nested_layer_7_ddos_defense_config"></a>The <code>layer_7_ddos_defense_config</code> block supports:</p>

<ul>
<li><p><code>enable</code> - (Optional) If set to true, enables CAAP for L7 DDoS detection.</p></li>
<li><p><code>rule_visibility</code> - (Optional) Rule visibility can be one of the following:</p>

<ul>
<li><code>STANDARD</code> - opaque rules. (default)</li>
<li><code>PREMIUM</code> - transparent rules.</li>
</ul></li>
<li><p><code>threshold_configs</code> - (Optional) Configuration options for layer7 adaptive protection for various customizable thresholds. Structure is <a href="#nested_threshold_configs">documented below</a>.</p></li>
</ul>

<p><a name="nested_threshold_configs"></a>The <code>threshold_configs</code> block supports:</p>

<ul>
<li><p><code>name</code> - The name of config. The name must be 1-63 characters long, and comply with RFC1035. The name must be unique within the security policy.</p></li>
<li><p><code>auto_deploy_load_threshold</code> - (Optional) Load threshold above which Adaptive Protection automatically deploy threshold based on the backend load threshold and detect a new rule during an alerted attack.</p></li>
<li><p><code>auto_deploy_confidence_threshold</code> - (Optional) Confidence threshold above which Adaptive Protection's auto-deploy takes actions.</p></li>
<li><p><code>auto_deploy_impacted_baseline_threshold</code> - (Optional) Impacted baseline threshold below which Adaptive Protection's auto-deploy takes actions.</p></li>
<li><p><code>auto_deploy_expiration_sec</code> - (Optional) Duration over which Adaptive Protection's auto-deployed actions last.</p></li>
<li><p><code>detection_load_threshold</code> - (Optional) Detection threshold based on the backend service's load.</p></li>
<li><p><code>detection_absolute_qps</code> - (Optional) Detection threshold based on absolute QPS.</p></li>
<li><p><code>detection_relative_to_baseline_qps</code> - (Optional) Detection threshold based on QPS relative to the average of baseline traffic.</p></li>
<li><p><code>traffic_granularity_configs</code> - (Optional) Configuration options for enabling Adaptive Protection to work on the specified service granularity. Structure is <a href="#nested_traffic_granularity_configs">documented below</a>.</p></li>
</ul>

<p><a name="nested_traffic_granularity_configs"></a>The <code>traffic_granularity_configs</code> block supports:</p>

<ul>
<li><p><code>type</code> - The type of this configuration, a granular traffic unit can be one of the following:</p>

<ul>
<li><code>HTTP_HEADER_HOST</code></li>
<li><code>HTTP_PATH</code></li>
</ul></li>
<li><p><code>value</code> - (Optional) Requests that match this value constitute a granular traffic unit.</p></li>
<li><p><code>enable_each_unique_value</code> - (Optional) If enabled, traffic matching each unique value for the specified type constitutes a separate traffic unit. It can only be set to true if value is empty.</p></li>
</ul>

<p><a name="nested_auto_deploy_config"></a>The <code>auto_deploy_config</code> block supports:</p>

<ul>
<li><p><code>load_threshold</code> - (Optional) Identifies new attackers only when the load to the backend service that is under attack exceeds this threshold.</p></li>
<li><p><code>confidence_threshold</code> - (Optional) Rules are only automatically deployed for alerts on potential attacks with confidence scores greater than this threshold.</p></li>
<li><p><code>impacted_baseline_threshold</code> - (Optional) Rules are only automatically deployed when the estimated impact to baseline traffic from the suggested mitigation is below this threshold.</p></li>
<li><p><code>expiration_sec</code> - (Optional) Google Cloud Armor stops applying the action in the automatically deployed rule to an identified attacker after this duration. The rule continues to operate against new requests.</p></li>
</ul>

<p><a name="nested_recaptcha_options_config"></a>The <code>recaptcha_options_config</code> block supports:</p>

<ul>
<li><code>redirect_site_key</code> - (Required) A field to supply a reCAPTCHA site key to be used for all the rules using the redirect action with the type of <code>GOOGLE_RECAPTCHA</code> under the security policy. The specified site key needs to be created from the reCAPTCHA API. The user is responsible for the validity of the specified site key. If not specified, a Google-managed site key is used.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Attributes%20Reference"></a><h2 id="attributes-reference">Attributes Reference</h2>

<p>In addition to the arguments listed above, the following computed attributes are
exported:</p>

<ul>
<li><p><code>id</code> - an identifier for the resource with format <code>projects/{{project}}/global/securityPolicies/{{name}}</code></p></li>
<li><p><code>fingerprint</code> - Fingerprint of this resource.</p></li>
<li><p><code>self_link</code> - The URI of the created resource.</p></li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Import"></a><h2 id="import">Import</h2>

<p>Security policies can be imported using any of these accepted formats:</p>

<ul>
<li><code>projects/{{project}}/global/securityPolicies/{{name}}</code></li>
<li><code>{{project}}/{{name}}</code></li>
<li><code>{{name}}</code></li>
</ul>

<p>In Terraform v1.5.0 and later, use an <a href="https://developer.hashicorp.com/terraform/language/import"><code>import</code> block</a> to import security policies using one of the formats above. For example:</p>

<div class="codehilite"><pre><span></span><code><span class="nb">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"projects/{{project}}/global/securityPolicies/{{name}}"</span><span class="w"></span>
<span class="w">  </span><span class="na">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_compute_security_policy.default</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>When using the <a href="https://developer.hashicorp.com/terraform/cli/commands/import"><code>terraform import</code> command</a>, security policies can be imported using one of the formats above. For example:</p>

<pre><code>$ terraform import google_compute_security_policy.default projects/{{project}}/global/securityPolicies/{{name}}
$ terraform import google_compute_security_policy.default {{project}}/{{name}}
$ terraform import google_compute_security_policy.default {{name}}
</code></pre>

            
        
    </body></html>