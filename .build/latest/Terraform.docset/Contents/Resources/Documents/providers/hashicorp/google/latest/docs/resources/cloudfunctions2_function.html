<html><!-- Online page at https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloudfunctions2_function --><head>
                <title>google_cloudfunctions2_function</title>
                <meta charset="utf-8"/>
                <link href="../../../../../../style.css" rel="stylesheet"/>
            </head>
            <body>
                <h1 id="google_cloudfunctions2_function">google_cloudfunctions2_function</h1>

<p>A Cloud Function that contains user computation executed in response to an event.</p>

<p>To get more information about function, see:</p>

<ul>
<li><a href="https://cloud.google.com/functions/docs/reference/rest/v2beta/projects.locations.functions">API documentation</a></li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Basic"></a><h2 id="example-usage-cloudfunctions2-basic">Example Usage - Cloudfunctions2 Basic</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-v2"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Full"></a><h2 id="example-usage-cloudfunctions2-full">Example Usage - Cloudfunctions2 Full</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_pubsub_topic"</span><span class="w"> </span><span class="nv">"topic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"functions2-topic"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloPubSub"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">BUILD_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"build_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"4Gi"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_request_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">    </span><span class="na">available_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4"</span><span class="w"></span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_TEST</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"config_test"</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_DIFF_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">ingress_settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ALLOW_INTERNAL_ONLY"</span><span class="w"></span>
<span class="w">    </span><span class="na">all_traffic_on_latest_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">trigger_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">    </span><span class="na">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"google.cloud.pubsub.topic.v1.messagePublished"</span><span class="w"></span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.topic.id</span><span class="w"></span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RETRY_POLICY_RETRY"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Scheduler%20Auth"></a><h2 id="example-usage-cloudfunctions2-scheduler-auth">Example Usage - Cloudfunctions2 Scheduler Auth</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="c1"> # name should use kebab-case so generated Cloud Run service name will be the same</span>
<span class="w">  </span><span class="na">location</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function_iam_member"</span><span class="w"> </span><span class="nv">"invoker"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.project</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.location</span><span class="w"></span>
<span class="w">  </span><span class="na">cloud_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.name</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/cloudfunctions.invoker"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloud_run_service_iam_member"</span><span class="w"> </span><span class="nv">"cloud_run_invoker"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.project</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.location</span><span class="w"></span>
<span class="w">  </span><span class="na">service</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.name</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/run.invoker"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloud_scheduler_job"</span><span class="w"> </span><span class="nv">"invoke_cloud_function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"invoke-gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Schedule the HTTPS trigger for cloud function"</span><span class="w"></span>
<span class="w">  </span><span class="na">schedule</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"0 0 * * *"</span><span class="c1"> # every day at midnight</span>
<span class="w">  </span><span class="na">project</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.project</span><span class="w"></span>
<span class="w">  </span><span class="na">region</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.location</span><span class="w"></span>

<span class="w">  </span><span class="nb">http_target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">uri</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.function.service_config[0].uri</span><span class="w"></span>
<span class="w">    </span><span class="na">http_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"POST"</span><span class="w"></span>
<span class="w">    </span><span class="nb">oidc_token</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">audience</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"${google_cloudfunctions2_function.function.service_config[0].uri}/"</span><span class="w"></span>
<span class="w">      </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Basic%20Gcs"></a><h2 id="example-usage-cloudfunctions2-basic-gcs">Example Usage - Cloudfunctions2 Basic Gcs</h2>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"source-bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-source-bucket"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.source-bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"trigger-bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-trigger-bucket"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="c1"> # The trigger must be in the same location as the bucket</span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"google_storage_project_service_account"</span><span class="w"> </span><span class="nv">"gcs_account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># To use GCS CloudEvent triggers, the GCS service account requires the Pub/Sub Publisher(roles/pubsub.publisher) IAM role in the specified project.</span>
<span class="c1"># (See https://cloud.google.com/eventarc/docs/run/quickstart-storage#before-you-begin)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"gcs-pubsub-publishing"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/pubsub.publisher"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${data.google_storage_project_service_account.gcs_account.email_address}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account - used for both the cloud function and eventarc trigger in the test"</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># Permissions on the service account used by the function and Eventarc trigger</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"invoking"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/run.invoker"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_project_iam_member.gcs-pubsub-publishing</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"event-receiving"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/eventarc.eventReceiver"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_project_iam_member.invoking</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"artifactregistry-reader"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/artifactregistry.reader"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_project_iam_member.event-receiving</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.event-receiving</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.artifactregistry-reader</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs12"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"entryPoint"</span><span class="c1"> # Set the entry point in the code</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">BUILD_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"build_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.source-bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"config_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">ingress_settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ALLOW_INTERNAL_ONLY"</span><span class="w"></span>
<span class="w">    </span><span class="na">all_traffic_on_latest_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"google.cloud.storage.object.v1.finalized"</span><span class="w"></span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RETRY_POLICY_RETRY"</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">    </span><span class="nb">event_filters</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bucket"</span><span class="w"></span>
<span class="w">      </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.trigger-bucket.name</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Basic%20Auditlogs"></a><h2 id="example-usage-cloudfunctions2-basic-auditlogs">Example Usage - Cloudfunctions2 Basic Auditlogs</h2>

<div class="codehilite"><pre><span></span><code><span class="c1"># This example follows the examples shown in this Google Cloud Community blog post</span>
<span class="c1"># https://medium.com/google-cloud/applying-a-path-pattern-when-filtering-in-eventarc-f06b937b4c34</span>
<span class="c1"># and the docs:</span>
<span class="c1"># https://cloud.google.com/eventarc/docs/path-patterns</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"source-bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-source-bucket"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.source-bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account - used for both the cloud function and eventarc trigger in the test"</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># Note: The right way of listening for Cloud Storage events is to use a Cloud Storage trigger.</span>
<span class="c1"># Here we use Audit Logs to monitor the bucket so path patterns can be used in the example of</span>
<span class="c1"># google_cloudfunctions2_function below (Audit Log events have path pattern support)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"audit-log-bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-auditlog-bucket"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="c1">  # The trigger must be in the same location as the bucket</span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># Permissions on the service account used by the function and Eventarc trigger</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"invoking"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/run.invoker"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"event-receiving"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/eventarc.eventReceiver"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_project_iam_member.invoking</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"artifactregistry-reader"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/artifactregistry.reader"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_project_iam_member.event-receiving</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.event-receiving</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.artifactregistry-reader</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs12"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"entryPoint"</span><span class="c1"> # Set the entry point in the code</span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">BUILD_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"build_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.source-bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"config_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">ingress_settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ALLOW_INTERNAL_ONLY"</span><span class="w"></span>
<span class="w">    </span><span class="na">all_traffic_on_latest_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">trigger_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="c1"> # The trigger must be in the same location as the bucket</span>
<span class="w">    </span><span class="na">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"google.cloud.audit.log.v1.written"</span><span class="w"></span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RETRY_POLICY_RETRY"</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">    </span><span class="nb">event_filters</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceName"</span><span class="w"></span>
<span class="w">      </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"storage.googleapis.com"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">event_filters</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"methodName"</span><span class="w"></span>
<span class="w">      </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"storage.objects.create"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">event_filters</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"resourceName"</span><span class="w"></span>
<span class="w">      </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/projects/_/buckets/${google_storage_bucket.audit-log-bucket.name}/objects/*.txt"</span><span class="c1"> # Path pattern selects all .txt files in the bucket</span>
<span class="w">      </span><span class="na">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"match-path-pattern"</span><span class="c1"> # This allows path patterns to be used in the value field</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Basic%20Builder"></a><h2 id="example-usage-cloudfunctions2-basic-builder">Example Usage - Cloudfunctions2 Basic Builder</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"log_writer"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.project</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/logging.logWriter"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"artifact_registry_writer"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.project</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/artifactregistry.writer"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_iam_member"</span><span class="w"> </span><span class="nv">"storage_object_admin"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.project</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/storage.objectAdmin"</span><span class="w"></span>
<span class="w">  </span><span class="na">member</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"serviceAccount:${google_service_account.account.email}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># builder permissions need to stablize before it can pull the source zip</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"time_sleep"</span><span class="w"> </span><span class="nv">"wait_60s"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">create_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"60s"</span><span class="w"></span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.log_writer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.artifact_registry_writer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_iam_member.storage_object_admin</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-v2"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.id</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">time_sleep.wait_60s</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Secret%20Env"></a><h2 id="example-usage-cloudfunctions2-secret-env">Example Usage - Cloudfunctions2 Secret Env</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-secret"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>

<span class="w">    </span><span class="nb">secret_environment_variables</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">key</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"TEST"</span><span class="w"></span>
<span class="w">      </span><span class="na">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.project</span><span class="w"></span>
<span class="w">      </span><span class="na">secret</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">google_secret_manager_secret.secret.secret_id</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"latest"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_secret_manager_secret_version.secret</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_secret_manager_secret"</span><span class="w"> </span><span class="nv">"secret"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">secret_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"secret"</span><span class="w"></span>

<span class="w">  </span><span class="nb">replication</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">user_managed</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">replicas</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_secret_manager_secret_version"</span><span class="w"> </span><span class="nv">"secret"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_secret_manager_secret.secret.name</span><span class="w"></span>

<span class="w">  </span><span class="na">secret_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"secret"</span><span class="w"></span>
<span class="w">  </span><span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Secret%20Volume"></a><h2 id="example-usage-cloudfunctions2-secret-volume">Example Usage - Cloudfunctions2 Secret Volume</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-secret"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>

<span class="w">    </span><span class="nb">secret_volumes</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">mount_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/etc/secrets"</span><span class="w"></span>
<span class="w">      </span><span class="na">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.project</span><span class="w"></span>
<span class="w">      </span><span class="na">secret</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">google_secret_manager_secret.secret.secret_id</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">google_secret_manager_secret_version.secret</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_secret_manager_secret"</span><span class="w"> </span><span class="nv">"secret"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">secret_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"secret"</span><span class="w"></span>

<span class="w">  </span><span class="nb">replication</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">user_managed</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">replicas</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_secret_manager_secret_version"</span><span class="w"> </span><span class="nv">"secret"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_secret_manager_secret.secret.name</span><span class="w"></span>

<span class="w">  </span><span class="na">secret_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"secret"</span><span class="w"></span>
<span class="w">  </span><span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Private%20Workerpool"></a><h2 id="example-usage-cloudfunctions2-private-workerpool">Example Usage - Cloudfunctions2 Private Workerpool</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudbuild_worker_pool"</span><span class="w"> </span><span class="nv">"pool"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"workerpool"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="nb">worker_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">disk_size_gb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"></span>
<span class="w">    </span><span class="na">machine_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"e2-standard-8"</span><span class="w"></span>
<span class="w">    </span><span class="na">no_external_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-workerpool"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">worker_pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudbuild_worker_pool.pool.id</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Cmek%20Docs"></a><h2 id="example-usage-cloudfunctions2-cmek-docs">Example Usage - Cloudfunctions2 Cmek Docs</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"google_project"</span><span class="w"> </span><span class="nv">"project"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_project_service_identity"</span><span class="w"> </span><span class="nv">"ea_sa"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.google_project.project.project_id</span><span class="w"></span>
<span class="w">  </span><span class="na">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"eventarc.googleapis.com"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_artifact_registry_repository"</span><span class="w"> </span><span class="nv">"unencoded-ar-repo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">repository_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ar-repo"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DOCKER"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_artifact_registry_repository_iam_binding"</span><span class="w"> </span><span class="nv">"binding"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_artifact_registry_repository.encoded-ar-repo.location</span><span class="w"></span>
<span class="w">  </span><span class="na">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_artifact_registry_repository.encoded-ar-repo.name</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/artifactregistry.admin"</span><span class="w"></span>
<span class="w">  </span><span class="na">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"serviceAccount:service-${data.google_project.project.number}@gcf-admin-robot.iam.gserviceaccount.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_kms_crypto_key_iam_binding"</span><span class="w"> </span><span class="nv">"gcf_cmek_keyuser"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">crypto_key_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cmek-key"</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"roles/cloudkms.cryptoKeyEncrypterDecrypter"</span><span class="w"></span>

<span class="w">  </span><span class="na">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"serviceAccount:service-${data.google_project.project.number}@gcf-admin-robot.iam.gserviceaccount.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"serviceAccount:service-${data.google_project.project.number}@gcp-sa-artifactregistry.iam.gserviceaccount.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"serviceAccount:service-${data.google_project.project.number}@gs-project-accounts.iam.gserviceaccount.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"serviceAccount:service-${data.google_project.project.number}@serverless-robot-prod.iam.gserviceaccount.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_service_identity.ea_sa.member</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_project_service_identity.ea_sa</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_artifact_registry_repository"</span><span class="w"> </span><span class="nv">"encoded-ar-repo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">repository_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cmek-repo"</span><span class="w"></span>
<span class="w">  </span><span class="na">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DOCKER"</span><span class="w"></span>
<span class="w">  </span><span class="na">kms_key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cmek-key"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_kms_crypto_key_iam_binding.gcf_cmek_keyuser</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>

<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-cmek"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CMEK function"</span><span class="w"></span>
<span class="w">  </span><span class="na">kms_key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cmek-key"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloHttp"</span><span class="c1">  # Set the entry point</span>
<span class="w">    </span><span class="na">docker_repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_artifact_registry_repository.encoded-ar-repo.id</span><span class="w"></span>

<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"256M"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">google_kms_crypto_key_iam_binding.gcf_cmek_keyuser</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Abiu"></a><h2 id="example-usage-cloudfunctions2-abiu">Example Usage - Cloudfunctions2 Abiu</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_pubsub_topic"</span><span class="w"> </span><span class="nv">"topic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"functions2-topic"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"europe-west6"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloPubSub"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">BUILD_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"build_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">automatic_update_policy</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"4Gi"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_request_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">    </span><span class="na">available_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4"</span><span class="w"></span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"config_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">ingress_settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ALLOW_INTERNAL_ONLY"</span><span class="w"></span>
<span class="w">    </span><span class="na">all_traffic_on_latest_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">trigger_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">    </span><span class="na">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"google.cloud.pubsub.topic.v1.messagePublished"</span><span class="w"></span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.topic.id</span><span class="w"></span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RETRY_POLICY_RETRY"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage%20-%20Cloudfunctions2%20Abiu%20On%20Deploy"></a><h2 id="example-usage-cloudfunctions2-abiu-on-deploy">Example Usage - Cloudfunctions2 Abiu On Deploy</h2>

<div class="codehilite"><pre><span></span><code><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-project-name"</span><span class="c1"> # Google Cloud Platform Project ID</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_service_account"</span><span class="w"> </span><span class="nv">"account"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-sa"</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Test Service Account"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_pubsub_topic"</span><span class="w"> </span><span class="nv">"topic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"functions2-topic"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket"</span><span class="w"> </span><span class="nv">"bucket"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.project}-gcf-source"</span><span class="c1">  # Every bucket name must be globally unique</span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"US"</span><span class="w"></span>
<span class="w">  </span><span class="na">uniform_bucket_level_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_storage_bucket_object"</span><span class="w"> </span><span class="nv">"object"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"function-source.zip"</span><span class="c1">  # Add path to the zipped function source code</span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"google_cloudfunctions2_function"</span><span class="w"> </span><span class="nv">"function"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">google-beta</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gcf-function"</span><span class="w"></span>
<span class="w">  </span><span class="na">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"europe-west6"</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a new function"</span><span class="w"></span>

<span class="w">  </span><span class="nb">build_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nodejs16"</span><span class="w"></span>
<span class="w">    </span><span class="na">entry_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloPubSub"</span><span class="c1">  # Set the entry point </span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">BUILD_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"build_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nb">storage_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket.bucket.name</span><span class="w"></span>
<span class="w">        </span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_storage_bucket_object.object.name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">on_deploy_update_policy</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">service_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"></span>
<span class="w">    </span><span class="na">min_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">available_memory</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"4Gi"</span><span class="w"></span>
<span class="w">    </span><span class="na">timeout_seconds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">    </span><span class="na">max_instance_request_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">    </span><span class="na">available_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4"</span><span class="w"></span>
<span class="w">    </span><span class="nb">environment_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="na">SERVICE_CONFIG_TEST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"config_test"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="na">ingress_settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ALLOW_INTERNAL_ONLY"</span><span class="w"></span>
<span class="w">    </span><span class="na">all_traffic_on_latest_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">    </span><span class="na">service_account_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_service_account.account.email</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">event_trigger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">trigger_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-central1"</span><span class="w"></span>
<span class="w">    </span><span class="na">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"google.cloud.pubsub.topic.v1.messagePublished"</span><span class="w"></span>
<span class="w">    </span><span class="na">pubsub_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_pubsub_topic.topic.id</span><span class="w"></span>
<span class="w">    </span><span class="na">retry_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RETRY_POLICY_RETRY"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Argument%20Reference"></a><h2 id="argument-reference">Argument Reference</h2>

<p>The following arguments are supported:</p>

<ul>
<li><p><code>name</code> -
(Required)
A user-defined name of the function. Function names must
be unique globally and match pattern <code>projects/*/locations/*/functions/*</code>.</p></li>
<li><p><code>location</code> -
(Required)
The location of this cloud function.</p></li>
</ul>

<hr/>

<ul>
<li><p><code>description</code> -
(Optional)
User-provided description of a function.</p></li>
<li><p><code>build_config</code> -
(Optional)
Describes the Build step of the function that builds a container
from the given source.
Structure is <a href="#nested_build_config">documented below</a>.</p></li>
<li><p><code>service_config</code> -
(Optional)
Describes the Service being deployed.
Structure is <a href="#nested_service_config">documented below</a>.</p></li>
<li><p><code>event_trigger</code> -
(Optional)
An Eventarc trigger managed by Google Cloud Functions that fires events in
response to a condition in another service.
Structure is <a href="#nested_event_trigger">documented below</a>.</p></li>
<li><p><code>labels</code> -
(Optional)
A set of key/value label pairs associated with this Cloud Function.</p>

<p><strong>Note</strong>: This field is non-authoritative, and will only manage the labels present in your configuration.
Please refer to the field <code>effective_labels</code> for all of the labels present on the resource.</p></li>
<li><p><code>kms_key_name</code> -
(Optional)
Resource name of a KMS crypto key (managed by the user) used to encrypt/decrypt function resources.
It must match the pattern projects/{project}/locations/{location}/keyRings/{key_ring}/cryptoKeys/{crypto_key}.</p></li>
<li><p><code>project</code> - (Optional) The ID of the project in which the resource belongs.
If it is not provided, the provider project is used.</p></li>
</ul>

<p><a name="nested_build_config"></a>The <code>build_config</code> block supports:</p>

<ul>
<li><p><code>build</code> -
(Output)
The Cloud Build name of the latest successful
deployment of the function.</p></li>
<li><p><code>runtime</code> -
(Optional)
The runtime in which to run the function. Required when deploying a new
function, optional when updating an existing function.</p></li>
<li><p><code>entry_point</code> -
(Optional)
The name of the function (as defined in source code) that will be executed.
Defaults to the resource name suffix, if not specified. For backward
compatibility, if function with given name is not found, then the system
will try to use function named "function". For Node.js this is name of a
function exported by the module specified in source_location.</p></li>
<li><p><code>source</code> -
(Optional)
The location of the function source code.
Structure is <a href="#nested_build_config_source">documented below</a>.</p></li>
<li><p><code>worker_pool</code> -
(Optional)
Name of the Cloud Build Custom Worker Pool that should be used to build the function.</p></li>
<li><p><code>environment_variables</code> -
(Optional)
User-provided build-time environment variables for the function.</p></li>
<li><p><code>docker_repository</code> -
(Optional)
User managed repository created in Artifact Registry optionally with a customer managed encryption key.</p></li>
<li><p><code>service_account</code> -
(Optional)
The fully-qualified name of the service account to be used for building the container.</p></li>
<li><p><code>automatic_update_policy</code> -
(Optional)
Security patches are applied automatically to the runtime without requiring
the function to be redeployed.</p></li>
<li><p><code>on_deploy_update_policy</code> -
(Optional)
Security patches are only applied when a function is redeployed.
Structure is <a href="#nested_build_config_on_deploy_update_policy">documented below</a>.</p></li>
</ul>

<p><a name="nested_build_config_source"></a>The <code>source</code> block supports:</p>

<ul>
<li><p><code>storage_source</code> -
(Optional)
If provided, get the source from this location in Google Cloud Storage.
Structure is <a href="#nested_build_config_source_storage_source">documented below</a>.</p></li>
<li><p><code>repo_source</code> -
(Optional)
If provided, get the source from this location in a Cloud Source Repository.
Structure is <a href="#nested_build_config_source_repo_source">documented below</a>.</p></li>
</ul>

<p><a name="nested_build_config_source_storage_source"></a>The <code>storage_source</code> block supports:</p>

<ul>
<li><p><code>bucket</code> -
(Optional)
Google Cloud Storage bucket containing the source</p></li>
<li><p><code>object</code> -
(Optional)
Google Cloud Storage object containing the source.</p></li>
<li><p><code>generation</code> -
(Optional)
Google Cloud Storage generation for the object. If the generation
is omitted, the latest generation will be used.</p></li>
</ul>

<p><a name="nested_build_config_source_repo_source"></a>The <code>repo_source</code> block supports:</p>

<ul>
<li><p><code>project_id</code> -
(Optional)
ID of the project that owns the Cloud Source Repository. If omitted, the
project ID requesting the build is assumed.</p></li>
<li><p><code>repo_name</code> -
(Optional)
Name of the Cloud Source Repository.</p></li>
<li><p><code>branch_name</code> -
(Optional)
Regex matching branches to build.</p></li>
<li><p><code>tag_name</code> -
(Optional)
Regex matching tags to build.</p></li>
<li><p><code>commit_sha</code> -
(Optional)
Regex matching tags to build.</p></li>
<li><p><code>dir</code> -
(Optional)
Directory, relative to the source root, in which to run the build.</p></li>
<li><p><code>invert_regex</code> -
(Optional)
Only trigger a build if the revision regex does
NOT match the revision regex.</p></li>
</ul>

<p><a name="nested_build_config_on_deploy_update_policy"></a>The <code>on_deploy_update_policy</code> block supports:</p>

<ul>
<li><code>runtime_version</code> -
(Output)
The runtime version which was used during latest function deployment.</li>
</ul>

<p><a name="nested_service_config"></a>The <code>service_config</code> block supports:</p>

<ul>
<li><p><code>service</code> -
(Optional)
Name of the service associated with a Function.</p></li>
<li><p><code>timeout_seconds</code> -
(Optional)
The function execution timeout. Execution is considered failed and
can be terminated if the function is not completed at the end of the
timeout period. Defaults to 60 seconds.</p></li>
<li><p><code>available_memory</code> -
(Optional)
The amount of memory available for a function.
Defaults to 256M. Supported units are k, M, G, Mi, Gi. If no unit is
supplied the value is interpreted as bytes.</p></li>
<li><p><code>max_instance_request_concurrency</code> -
(Optional)
Sets the maximum number of concurrent requests that each instance can receive. Defaults to 1.</p></li>
<li><p><code>available_cpu</code> -
(Optional)
The number of CPUs used in a single container instance. Default value is calculated from available memory.</p></li>
<li><p><code>environment_variables</code> -
(Optional)
Environment variables that shall be available during function execution.</p></li>
<li><p><code>max_instance_count</code> -
(Optional)
The limit on the maximum number of function instances that may coexist at a
given time.</p></li>
<li><p><code>min_instance_count</code> -
(Optional)
The limit on the minimum number of function instances that may coexist at a
given time.</p></li>
<li><p><code>vpc_connector</code> -
(Optional)
The Serverless VPC Access connector that this cloud function can connect to.</p></li>
<li><p><code>vpc_connector_egress_settings</code> -
(Optional)
Available egress settings.
Possible values are: <code>VPC_CONNECTOR_EGRESS_SETTINGS_UNSPECIFIED</code>, <code>PRIVATE_RANGES_ONLY</code>, <code>ALL_TRAFFIC</code>.</p></li>
<li><p><code>ingress_settings</code> -
(Optional)
Available ingress settings. Defaults to "ALLOW_ALL" if unspecified.
Default value is <code>ALLOW_ALL</code>.
Possible values are: <code>ALLOW_ALL</code>, <code>ALLOW_INTERNAL_ONLY</code>, <code>ALLOW_INTERNAL_AND_GCLB</code>.</p></li>
<li><p><code>uri</code> -
(Output)
URI of the Service deployed.</p></li>
<li><p><code>gcf_uri</code> -
(Output)
URIs of the Service deployed</p></li>
<li><p><code>service_account_email</code> -
(Optional)
The email of the service account for this function.</p></li>
<li><p><code>all_traffic_on_latest_revision</code> -
(Optional)
Whether 100% of traffic is routed to the latest revision. Defaults to true.</p></li>
<li><p><code>secret_environment_variables</code> -
(Optional)
Secret environment variables configuration.
Structure is <a href="#nested_service_config_secret_environment_variables">documented below</a>.</p></li>
<li><p><code>secret_volumes</code> -
(Optional)
Secret volumes configuration.
Structure is <a href="#nested_service_config_secret_volumes">documented below</a>.</p></li>
</ul>

<p><a name="nested_service_config_secret_environment_variables"></a>The <code>secret_environment_variables</code> block supports:</p>

<ul>
<li><p><code>key</code> -
(Required)
Name of the environment variable.</p></li>
<li><p><code>project_id</code> -
(Required)
Project identifier (preferably project number but can also be the project ID) of the project that contains the secret. If not set, it will be populated with the function's project assuming that the secret exists in the same project as of the function.</p></li>
<li><p><code>secret</code> -
(Required)
Name of the secret in secret manager (not the full resource name).</p></li>
<li><p><code>version</code> -
(Required)
Version of the secret (version number or the string 'latest'). It is recommended to use a numeric version for secret environment variables as any updates to the secret value is not reflected until new instances start.</p></li>
</ul>

<p><a name="nested_service_config_secret_volumes"></a>The <code>secret_volumes</code> block supports:</p>

<ul>
<li><p><code>mount_path</code> -
(Required)
The path within the container to mount the secret volume. For example, setting the mountPath as /etc/secrets would mount the secret value files under the /etc/secrets directory. This directory will also be completely shadowed and unavailable to mount any other secrets. Recommended mount path: /etc/secrets</p></li>
<li><p><code>project_id</code> -
(Required)
Project identifier (preferably project number but can also be the project ID) of the project that contains the secret. If not set, it will be populated with the function's project assuming that the secret exists in the same project as of the function.</p></li>
<li><p><code>secret</code> -
(Required)
Name of the secret in secret manager (not the full resource name).</p></li>
<li><p><code>versions</code> -
(Optional)
List of secret versions to mount for this secret. If empty, the latest version of the secret will be made available in a file named after the secret under the mount point.'
Structure is <a href="#nested_service_config_secret_volumes_secret_volumes_versions">documented below</a>.</p></li>
</ul>

<p><a name="nested_service_config_secret_volumes_secret_volumes_versions"></a>The <code>versions</code> block supports:</p>

<ul>
<li><p><code>version</code> -
(Required)
Version of the secret (version number or the string 'latest'). It is preferable to use latest version with secret volumes as secret value changes are reflected immediately.</p></li>
<li><p><code>path</code> -
(Required)
Relative path of the file under the mount path where the secret value for this version will be fetched and made available. For example, setting the mountPath as '/etc/secrets' and path as secret_foo would mount the secret value file at /etc/secrets/secret_foo.</p></li>
</ul>

<p><a name="nested_event_trigger"></a>The <code>event_trigger</code> block supports:</p>

<ul>
<li><p><code>trigger</code> -
(Output)
Output only. The resource name of the Eventarc trigger.</p></li>
<li><p><code>trigger_region</code> -
(Optional)
The region that the trigger will be in. The trigger will only receive
events originating in this region. It can be the same
region as the function, a different region or multi-region, or the global
region. If not provided, defaults to the same region as the function.</p></li>
<li><p><code>event_type</code> -
(Optional)
Required. The type of event to observe.</p></li>
<li><p><code>event_filters</code> -
(Optional)
Criteria used to filter events.
Structure is <a href="#nested_event_trigger_event_filters">documented below</a>.</p></li>
<li><p><code>pubsub_topic</code> -
(Optional)
The name of a Pub/Sub topic in the same project that will be used
as the transport topic for the event delivery.</p></li>
<li><p><code>service_account_email</code> -
(Optional)
Optional. The email of the trigger's service account. The service account
must have permission to invoke Cloud Run services. If empty, defaults to the
Compute Engine default service account: {project_number}-compute@developer.gserviceaccount.com.</p></li>
<li><p><code>retry_policy</code> -
(Optional)
Describes the retry policy in case of function's execution failure.
Retried execution is charged as any other execution.
Possible values are: <code>RETRY_POLICY_UNSPECIFIED</code>, <code>RETRY_POLICY_DO_NOT_RETRY</code>, <code>RETRY_POLICY_RETRY</code>.</p></li>
</ul>

<p><a name="nested_event_trigger_event_filters"></a>The <code>event_filters</code> block supports:</p>

<ul>
<li><p><code>attribute</code> -
(Required)
'Required. The name of a CloudEvents attribute.
Currently, only a subset of attributes are supported for filtering. Use the <code>gcloud eventarc providers describe</code> command to learn more about events and their attributes.
Do not filter for the 'type' attribute here, as this is already achieved by the resource's <code>event_type</code> attribute.</p></li>
<li><p><code>value</code> -
(Required)
Required. The value for the attribute.
If the operator field is set as <code>match-path-pattern</code>, this value can be a path pattern instead of an exact value.</p></li>
<li><p><code>operator</code> -
(Optional)
Optional. The operator used for matching the events with the value of
the filter. If not specified, only events that have an exact key-value
pair specified in the filter are matched.
The only allowed value is <code>match-path-pattern</code>.
<a href="https://cloud.google.com/eventarc/docs/path-patterns">See documentation on path patterns here</a>'</p></li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Attributes%20Reference"></a><h2 id="attributes-reference">Attributes Reference</h2>

<p>In addition to the arguments listed above, the following computed attributes are exported:</p>

<ul>
<li><p><code>id</code> - an identifier for the resource with format <code>projects/{{project}}/locations/{{location}}/functions/{{name}}</code></p></li>
<li><p><code>environment</code> -
The environment the function is hosted on.</p></li>
<li><p><code>url</code> -
Output only. The deployed url for the function.</p></li>
<li><p><code>state</code> -
Describes the current state of the function.</p></li>
<li><p><code>update_time</code> -
The last update timestamp of a Cloud Function.</p></li>
<li><p><code>terraform_labels</code> -
The combination of labels configured directly on the resource
and default labels configured on the provider.</p></li>
<li><p><code>effective_labels</code> -
All of labels (key/value pairs) present on the resource in GCP, including the labels configured through Terraform, other clients and services.</p></li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Timeouts"></a><h2 id="timeouts">Timeouts</h2>

<p>This resource provides the following
<a href="https://developer.hashicorp.com/terraform/plugin/sdkv2/resources/retries-and-customizable-timeouts">Timeouts</a> configuration options:</p>

<ul>
<li><code>create</code> - Default is 60 minutes.</li>
<li><code>update</code> - Default is 60 minutes.</li>
<li><code>delete</code> - Default is 60 minutes.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Import"></a><h2 id="import">Import</h2>

<p>function can be imported using any of these accepted formats:</p>

<ul>
<li><code>projects/{{project}}/locations/{{location}}/functions/{{name}}</code></li>
<li><code>{{project}}/{{location}}/{{name}}</code></li>
<li><code>{{location}}/{{name}}</code></li>
</ul>

<p>In Terraform v1.5.0 and later, use an <a href="https://developer.hashicorp.com/terraform/language/import"><code>import</code> block</a> to import function using one of the formats above. For example:</p>

<div class="codehilite"><pre><span></span><code><span class="nb">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"projects/{{project}}/locations/{{location}}/functions/{{name}}"</span><span class="w"></span>
<span class="w">  </span><span class="na">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">google_cloudfunctions2_function.default</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>When using the <a href="https://developer.hashicorp.com/terraform/cli/commands/import"><code>terraform import</code> command</a>, function can be imported using one of the formats above. For example:</p>

<pre><code>$ terraform import google_cloudfunctions2_function.default projects/{{project}}/locations/{{location}}/functions/{{name}}
$ terraform import google_cloudfunctions2_function.default {{project}}/{{location}}/{{name}}
$ terraform import google_cloudfunctions2_function.default {{location}}/{{name}}
</code></pre>

<a class="dashAnchor" name="//apple_ref/cpp/Section/User%20Project%20Overrides"></a><h2 id="user-project-overrides">User Project Overrides</h2>

<p>This resource supports <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#user_project_override">User Project Overrides</a>.</p>

            
        
    </body></html>