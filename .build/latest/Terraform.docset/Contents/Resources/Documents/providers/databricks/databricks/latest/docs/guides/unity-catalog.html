<html><!-- Online page at https://registry.terraform.io/providers/databricks/databricks/latest/docs/guides/unity-catalog --><head>
                <title>Deploying pre-requisite resources and enabling Unity Catalog</title>
                <meta charset="utf-8"/>
                <link href="../../../../../../style.css" rel="stylesheet"/>
            </head>
            <body>
                <h1 id="deploying-pre-requisite-resources-and-enabling-unity-catalog">Deploying pre-requisite resources and enabling Unity Catalog</h1>

<p><strong>Note</strong>
If your workspace was enabled for Unity Catalog automatically, this guide does not apply to you. See <a href="unity-catalog-default.md">this guide</a> instead.</p>

<p><strong>Note</strong>
Except for metastore, metastore assignment and storage credential objects, Unity Catalog APIs are accessible via <strong>workspace-level APIs</strong>. This design may change in the future.</p>

<p>Databricks Unity Catalog brings fine-grained governance and security to Lakehouse data using a familiar, open interface. You can use Terraform to deploy the underlying cloud resources and Unity Catalog objects automatically, using a programmatic approach.</p>

<p>This guide creates a metastore without a storage root location or credential to maintain strict separation of storage across catalogs or environments.</p>

<p>This guide uses the following variables in configurations:</p>

<ul>
<li><code>databricks_client_id</code>: The <code>client_id</code> is the <code>application_id</code> of a <a href="../resources/service_principal.md">Service Principal</a> that has account-level admin permission on <a href="https://accounts.cloud.databricks.com">https://accounts.cloud.databricks.com</a>.</li>
<li><code>databricks_client_secret</code>: The secret of the above service principal.</li>
<li><code>databricks_account_id</code>: The numeric ID for your Databricks account. When you are logged in, it appears in the top right corner of the <a href="https://accounts.cloud.databricks.com/">Databricks Account Console</a> or <a href="https://accounts.azuredatabricks.net">Azure Databricks Account Console</a>.</li>
<li><code>databricks_workspace_url</code>: Value of <code>workspace_url</code> attribute from <a href="../resources/mws_workspaces.md#attribute-reference">databricks_mws_workspaces</a> resource.</li>
</ul>

<p>This guide is provided as-is and you can use this guide as the basis for your custom Terraform module.</p>

<p>To get started with Unity Catalog, this guide takes you through the following high-level steps:</p>

<ul>
<li><a href="#deploying-pre-requisite-resources-and-enabling-unity-catalog">Deploying pre-requisite resources and enabling Unity Catalog</a>
<ul>
<li><a href="#provider-initialization">Provider initialization</a></li>
<li><a href="#create-users-and-groups">Create users and groups</a></li>
<li><a href="#create-a-unity-catalog-metastore-and-link-it-to-workspaces">Create a Unity Catalog metastore and link it to workspaces</a></li>
<li><a href="#configure-external-locations-and-credentials">Configure external locations and credentials</a></li>
<li><a href="#create-unity-catalog-objects-in-the-metastore">Create Unity Catalog objects in the metastore</a></li>
<li><a href="#configure-unity-catalog-clusters">Configure Unity Catalog clusters</a></li>
</ul></li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Provider%20initialization"></a><h2 id="provider-initialization">Provider initialization</h2>

<p>Initialize <a href="https://www.terraform.io/language/providers/configuration#alias-multiple-provider-configurations">provider with <code>mws</code> alias</a> to set up account-level resources. See <a href="../index.md#authenticating-with-databricks-managed-service-principal">provider authentication</a> for more details.</p>

<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">databricks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"databricks/databricks"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"hashicorp/aws"</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"3.49.0"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">"aws"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1">// initialize provider in "MWS" mode for account-level resources</span>
<span class="kr">provider</span><span class="w"> </span><span class="nv">"databricks"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">alias</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"mws"</span><span class="w"></span>
<span class="w">  </span><span class="na">host</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://accounts.cloud.databricks.com"</span><span class="w"></span>
<span class="w">  </span><span class="na">account_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_account_id</span><span class="w"></span>
<span class="w">  </span><span class="na">client_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_client_id</span><span class="w"></span>
<span class="w">  </span><span class="na">client_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_client_secret</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1">// initialize provider at workspace level, to create UC resources</span>
<span class="kr">provider</span><span class="w"> </span><span class="nv">"databricks"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">alias</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"workspace"</span><span class="w"></span>
<span class="w">  </span><span class="na">host</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_workspace_url</span><span class="w"></span>
<span class="w">  </span><span class="na">client_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_client_id</span><span class="w"></span>
<span class="w">  </span><span class="na">client_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.databricks_client_secret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Define the required variables</p>

<div class="codehilite"><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_client_id"</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_client_secret"</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_account_id"</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_workspace_url"</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"tags"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"region"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"eu-west-1"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_workspace_ids"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="dl">EOT</span><span class="sh"></span>
<span class="err">  List of Databricks workspace IDs to be enabled with Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g. ["111111111", "222222222"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "databricks_users" {</span>
<span class="err">  description = &lt;&lt;EOT</span>
<span class="err">  List of Databricks users to be added at account-level for Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g ["first.last@domain.com", "second.last@domain.com"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "databricks_metastore_admins" {</span>
<span class="err">  description = &lt;&lt;EOT</span>
<span class="err">  List of Admins to be added at account-level for Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g ["first.admin@domain.com", "second.admin@domain.com"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "unity_admin_group" {</span>
<span class="err">  description = "Name of the admin group. This group will be set as the owner of the Unity Catalog metastore"</span>
<span class="err">  type        = string</span>
<span class="err">}</span>

<span class="err">//generate a random string as the prefix for AWS resources, to ensure uniqueness</span>
<span class="err">resource "random_string" "naming" {</span>
<span class="err">  special = false</span>
<span class="err">  upper   = false</span>
<span class="err">  length  = 6</span>
<span class="err">}</span>

<span class="err">locals {</span>
<span class="err">  prefix = "demo${random_string.naming.result}"</span>
<span class="err">}</span>
<span class="w">  </span><span class="err">List</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">Databricks</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">IDs</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">enabled</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">Unity</span><span class="w"> </span><span class="err">Catalog</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="err">Enter</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">square</span><span class="w"> </span><span class="err">brackets</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">double</span><span class="w"> </span><span class="err">quotes</span><span class="w"></span>
<span class="w">  </span><span class="nv">e.g</span><span class="p">.</span><span class="w"> </span><span class="p">[</span><span class="s2">"111111111", "222222222"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="err">EOT</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_users"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="dl">EOT</span><span class="sh"></span>
<span class="err">  List of Databricks users to be added at account-level for Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g ["first.last@domain.com", "second.last@domain.com"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "databricks_metastore_admins" {</span>
<span class="err">  description = &lt;&lt;EOT</span>
<span class="err">  List of Admins to be added at account-level for Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g ["first.admin@domain.com", "second.admin@domain.com"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "unity_admin_group" {</span>
<span class="err">  description = "Name of the admin group. This group will be set as the owner of the Unity Catalog metastore"</span>
<span class="err">  type        = string</span>
<span class="err">}</span>

<span class="err">//generate a random string as the prefix for AWS resources, to ensure uniqueness</span>
<span class="err">resource "random_string" "naming" {</span>
<span class="err">  special = false</span>
<span class="err">  upper   = false</span>
<span class="err">  length  = 6</span>
<span class="err">}</span>

<span class="err">locals {</span>
<span class="err">  prefix = "demo${random_string.naming.result}"</span>
<span class="err">}</span>
<span class="w">  </span><span class="err">List</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">Databricks</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">added</span><span class="w"> </span><span class="err">at</span><span class="w"> </span><span class="err">account-level</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">Unity</span><span class="w"> </span><span class="err">Catalog</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="err">Enter</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">square</span><span class="w"> </span><span class="err">brackets</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">double</span><span class="w"> </span><span class="err">quotes</span><span class="w"></span>
<span class="w">  </span><span class="nv">e.g</span><span class="w"> </span><span class="p">[</span><span class="s2">"first.last@domain.com", "second.last@domain.com"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="err">EOT</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"databricks_metastore_admins"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="dl">EOT</span><span class="sh"></span>
<span class="err">  List of Admins to be added at account-level for Unity Catalog.</span>
<span class="err">  Enter with square brackets and double quotes</span>
<span class="err">  e.g ["first.admin@domain.com", "second.admin@domain.com"]</span>
<span class="err">  EOT</span>
<span class="err">  type        = list(string)</span>
<span class="err">}</span>

<span class="err">variable "unity_admin_group" {</span>
<span class="err">  description = "Name of the admin group. This group will be set as the owner of the Unity Catalog metastore"</span>
<span class="err">  type        = string</span>
<span class="err">}</span>

<span class="err">//generate a random string as the prefix for AWS resources, to ensure uniqueness</span>
<span class="err">resource "random_string" "naming" {</span>
<span class="err">  special = false</span>
<span class="err">  upper   = false</span>
<span class="err">  length  = 6</span>
<span class="err">}</span>

<span class="err">locals {</span>
<span class="err">  prefix = "demo${random_string.naming.result}"</span>
<span class="err">}</span>
<span class="w">  </span><span class="err">List</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">Admins</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">added</span><span class="w"> </span><span class="err">at</span><span class="w"> </span><span class="err">account-level</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">Unity</span><span class="w"> </span><span class="err">Catalog</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="err">Enter</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">square</span><span class="w"> </span><span class="err">brackets</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">double</span><span class="w"> </span><span class="err">quotes</span><span class="w"></span>
<span class="w">  </span><span class="nv">e.g</span><span class="w"> </span><span class="p">[</span><span class="s2">"first.admin@domain.com", "second.admin@domain.com"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="err">EOT</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">"unity_admin_group"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Name of the admin group. This group will be set as the owner of the Unity Catalog metastore"</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1">//generate a random string as the prefix for AWS resources, to ensure uniqueness</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"random_string"</span><span class="w"> </span><span class="nv">"naming"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="w"></span>
<span class="w">  </span><span class="na">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="w"></span>
<span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo${random_string.naming.result}"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Create%20users%20and%20groups"></a><h2 id="create-users-and-groups">Create users and groups</h2>

<p>A Unity Catalog <a href="../resources/metastore.md">databricks_metastore</a> can be shared across multiple Databricks workspaces. To enable this, Databricks must have a consistent view of users and groups across all workspaces, and has introduced features within the account console to manage this. Users and groups that wish to use Unity Catalog must be created as account level identities and as workspace-level identities. All users are added to the <code>account users</code> group by default.</p>

<aside class="admonition note">
    <strong>note</strong>
    <em>note</em>
    <p>Databricks does not allow a single user to be added to more than one Databricks account. You will receive the error <code>User already exists in another account</code>.</p>
</aside>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_user"</span><span class="w"> </span><span class="nv">"unity_users"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nf">concat</span><span class="p">(</span><span class="nv">var.databricks_users</span><span class="p">,</span><span class="w"> </span><span class="nv">var.databricks_metastore_admins</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="na">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span><span class="w"></span>
<span class="w">  </span><span class="na">force</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_group"</span><span class="w"> </span><span class="nv">"admin_group"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.unity_admin_group</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_group_member"</span><span class="w"> </span><span class="nv">"admin_group_member"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nv">var.databricks_metastore_admins</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="na">group_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_group.admin_group.id</span><span class="w"></span>
<span class="w">  </span><span class="na">member_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_user.unity_users[each.value].id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_user_role"</span><span class="w"> </span><span class="nv">"metastore_admin"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nv">var.databricks_metastore_admins</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="na">user_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_user.unity_users[each.value].id</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"account_admin"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Create%20a%20Unity%20Catalog%20metastore%20and%20link%20it%20to%20workspaces"></a><h2 id="create-a-unity-catalog-metastore-and-link-it-to-workspaces">Create a Unity Catalog metastore and link it to workspaces</h2>

<p>A <a href="../resources/metastore.md">databricks_metastore</a> is the top level container for data in Unity Catalog. You can only create a single metastore for each region in which your organization operates, and attach workspaces to the metastore. Each workspace will have the same view of the data you manage in Unity Catalog.</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_metastore"</span><span class="w"> </span><span class="nv">"this"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"primary"</span><span class="w"></span>
<span class="w">  </span><span class="na">owner</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.unity_admin_group</span><span class="w"></span>
<span class="w">  </span><span class="na">region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span><span class="w"></span>
<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_metastore_assignment"</span><span class="w"> </span><span class="nv">"default_metastore"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.mws</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nv">var.databricks_workspace_ids</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="na">workspace_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span><span class="w"></span>
<span class="w">  </span><span class="na">metastore_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_metastore.this.id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Configure%20external%20locations%20and%20credentials"></a><h2 id="configure-external-locations-and-credentials">Configure external locations and credentials</h2>

<p>Unity Catalog introduces two new objects to access and work with external cloud storage:</p>

<ul>
<li><a href="../resources/storage_credential.md">databricks_storage_credential</a> represent authentication methods to access cloud storage (e.g. an IAM role for Amazon S3 or a service principal for Azure Storage). Storage credentials are access-controlled to determine which users can use the credential.</li>
<li><a href="../resources/external_location.md">databricks_external_location</a> are objects that combine a cloud storage path with a Storage Credential that can be used to access the location.</li>
</ul>

<p>First, we need to create the storage credential in Databricks before creating the IAM role in AWS. This is because the external ID of the Databricks storage credential is required in the IAM role trust policy.</p>

<div class="codehilite"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="nc">"aws_caller_identity"</span><span class="w"> </span><span class="nv">"current"</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">uc_iam_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-uc-access"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_storage_credential"</span><span class="w"> </span><span class="nv">"external"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-external-access"</span><span class="c1"></span>
<span class="c1">  //cannot reference aws_iam_role directly, as it will create circular dependency</span>
<span class="w">  </span><span class="nb">aws_iam_role</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">role_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/${local.uc_iam_role}"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Managed by TF"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_grants"</span><span class="w"> </span><span class="nv">"external_creds"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">storage_credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_storage_credential.external.id</span><span class="w"></span>
<span class="w">  </span><span class="nb">grant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">principal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Data Engineers"</span><span class="w"></span>
<span class="w">    </span><span class="na">privileges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"CREATE_TABLE"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Then we can create the required objects in AWS</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_s3_bucket"</span><span class="w"> </span><span class="nv">"external"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-external"</span><span class="c1"></span>
<span class="c1">  // destroy all objects with bucket destroy</span>
<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">var.tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-external"</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_s3_bucket_versioning"</span><span class="w"> </span><span class="nv">"external_versioning"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.external.id</span><span class="w"></span>
<span class="w">  </span><span class="nb">versioning_configuration</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Disabled"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_aws_unity_catalog_assume_role_policy"</span><span class="w"> </span><span class="nv">"this"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">aws_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_caller_identity.current.account_id</span><span class="w"></span>
<span class="w">  </span><span class="na">role_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">local.uc_iam_role</span><span class="w"></span>
<span class="w">  </span><span class="na">external_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_storage_credential.external.aws_iam_role[0].external_id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_aws_unity_catalog_policy"</span><span class="w"> </span><span class="nv">"this"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">aws_account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_caller_identity.current.account_id</span><span class="w"></span>
<span class="w">  </span><span class="na">bucket_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.external.id</span><span class="w"></span>
<span class="w">  </span><span class="na">role_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">local.uc_iam_role</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_policy"</span><span class="w"> </span><span class="nv">"external_data_access"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_aws_unity_catalog_policy.this.json</span><span class="w"></span>
<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">var.tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-unity-catalog external access IAM policy"</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_role"</span><span class="w"> </span><span class="nv">"external_data_access"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">local.uc_iam_role</span><span class="w"></span>
<span class="w">  </span><span class="na">assume_role_policy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_aws_unity_catalog_assume_role_policy.this.json</span><span class="w"></span>
<span class="w">  </span><span class="na">managed_policy_arns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_iam_policy.external_data_access.arn</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">var.tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${local.prefix}-unity-catalog external access IAM role"</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Then we can create the <a href="../resources/external_location.md">databricks_external_location</a> in Unity Catalog.</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_external_location"</span><span class="w"> </span><span class="nv">"some"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"external"</span><span class="w"></span>
<span class="w">  </span><span class="na">url</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">"s3://${aws_s3_bucket.external.id}/some"</span><span class="w"></span>
<span class="w">  </span><span class="na">credential_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_storage_credential.external.id</span><span class="w"></span>
<span class="w">  </span><span class="na">comment</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"Managed by TF"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_grants"</span><span class="w"> </span><span class="nv">"some"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">external_location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_external_location.some.id</span><span class="w"></span>
<span class="w">  </span><span class="nb">grant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">principal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Data Engineers"</span><span class="w"></span>
<span class="w">    </span><span class="na">privileges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"CREATE_EXTERNAL_TABLE", "READ_FILES"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Create%20Unity%20Catalog%20objects%20in%20the%20metastore"></a><h2 id="create-unity-catalog-objects-in-the-metastore">Create Unity Catalog objects in the metastore</h2>

<p>Each metastore exposes a 3-level namespace (catalog-schema-table) by which data can be organized.</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_catalog"</span><span class="w"> </span><span class="nv">"sandbox"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">storage_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s3://${aws_s3_bucket.external.id}/some"</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"sandbox"</span><span class="w"></span>
<span class="w">  </span><span class="na">comment</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"this catalog is managed by terraform"</span><span class="w"></span>
<span class="w">  </span><span class="nb">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">purpose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"testing"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">databricks_metastore_assignment.default_metastore</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_grants"</span><span class="w"> </span><span class="nv">"sandbox"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">catalog</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_catalog.sandbox.name</span><span class="w"></span>
<span class="w">  </span><span class="nb">grant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">principal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Data Scientists"</span><span class="w"></span>
<span class="w">    </span><span class="na">privileges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"USE_CATALOG", "CREATE"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nb">grant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">principal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Data Engineers"</span><span class="w"></span>
<span class="w">    </span><span class="na">privileges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"USE_CATALOG"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_schema"</span><span class="w"> </span><span class="nv">"things"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">catalog_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_catalog.sandbox.id</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"things"</span><span class="w"></span>
<span class="w">  </span><span class="na">comment</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"this database is managed by terraform"</span><span class="w"></span>
<span class="w">  </span><span class="nb">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"various"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_grants"</span><span class="w"> </span><span class="nv">"things"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">schema</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_schema.things.id</span><span class="w"></span>
<span class="w">  </span><span class="nb">grant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">principal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Data Engineers"</span><span class="w"></span>
<span class="w">    </span><span class="na">privileges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"USE_SCHEMA"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Configure%20Unity%20Catalog%20clusters"></a><h2 id="configure-unity-catalog-clusters">Configure Unity Catalog clusters</h2>

<p>To ensure the integrity of ACLs, Unity Catalog data can be accessed only through compute resources configured with strong isolation guarantees and other security features. A Unity Catalog <a href="../resources/cluster.md">databricks_cluster</a> has the access mode set to either <strong>Shared</strong> or <strong>Single User</strong>.</p>

<ul>
<li><strong>Shared</strong> clusters can be shared by multiple users, but has certain <a href="https://docs.databricks.com/en/compute/access-mode-limitations.html#shared-access-mode-limitations-on-unity-catalog">limitations</a></li>
</ul>

<div class="codehilite"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_spark_version"</span><span class="w"> </span><span class="nv">"latest"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_node_type"</span><span class="w"> </span><span class="nv">"smallest"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">local_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_cluster"</span><span class="w"> </span><span class="nv">"unity_shared"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">cluster_name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"Shared clusters"</span><span class="w"></span>
<span class="w">  </span><span class="na">spark_version</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_spark_version.latest.id</span><span class="w"></span>
<span class="w">  </span><span class="na">node_type_id</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_node_type.smallest.id</span><span class="w"></span>
<span class="w">  </span><span class="na">autotermination_minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="w">  </span><span class="na">enable_elastic_disk</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="w"></span>
<span class="w">  </span><span class="na">num_workers</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="w">  </span><span class="nb">aws_attributes</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SPOT"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">data_security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"USER_ISOLATION"</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">databricks_metastore_assignment.this</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<ul>
<li>To use those advanced cluster features or languages like Machine Learning Runtime and R with Unity Catalog, one must choose <strong>Single User</strong> mode when launching the cluster. The cluster can only be used exclusively by a single user (by default the owner of the cluster); other users are not allowed to attach to the cluster.
The below example will create a collection of single-user <a href="../resources/cluster.md">databricks_cluster</a> for each user in a group managed through SCIM provisioning. Individual user will be able to restart their cluster, but not anyone else. Terraform's <code>for_each</code> meta-attribute will help us achieve this.</li>
</ul>

<p>First we use <a href="../data-sources/group.md">databricks_group</a> and <a href="../data-sources/user.md">databricks_user</a> data resources to get the list of user names that belong to a group.</p>

<div class="codehilite"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_group"</span><span class="w"> </span><span class="nv">"dev"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">display_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dev-clusters"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"databricks_user"</span><span class="w"> </span><span class="nv">"dev"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_group.dev.members</span><span class="w"></span>
<span class="w">  </span><span class="na">user_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Once we have a specific list of user resources, we could proceed creating single-user clusters and provide permissions with <code>for_each = data.databricks_user.dev</code> to ensure it's done for each user:</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_cluster"</span><span class="w"> </span><span class="nv">"dev"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_user.dev</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">cluster_name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"${each.value.display_name} unity cluster"</span><span class="w"></span>
<span class="w">  </span><span class="na">spark_version</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_spark_version.latest.id</span><span class="w"></span>
<span class="w">  </span><span class="na">node_type_id</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_node_type.smallest.id</span><span class="w"></span>
<span class="w">  </span><span class="na">autotermination_minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
<span class="w">  </span><span class="na">enable_elastic_disk</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">false</span><span class="w"></span>
<span class="w">  </span><span class="na">num_workers</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="w">  </span><span class="nb">aws_attributes</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SPOT"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="na">data_security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SINGLE_USER"</span><span class="w"></span>
<span class="w">  </span><span class="na">single_user_name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.user_name</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nv">databricks_metastore_assignment.this</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"databricks_permissions"</span><span class="w"> </span><span class="nv">"dev_restart"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">data.databricks_user.dev</span><span class="w"></span>
<span class="w">  </span><span class="na">provider</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks.workspace</span><span class="w"></span>
<span class="w">  </span><span class="na">cluster_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">databricks_cluster.dev[each.key].cluster_id</span><span class="w"></span>
<span class="w">  </span><span class="nb">access_control</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">user_name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.user_name</span><span class="w"></span>
<span class="w">    </span><span class="na">permission_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CAN_RESTART"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

            
        
    </body></html>