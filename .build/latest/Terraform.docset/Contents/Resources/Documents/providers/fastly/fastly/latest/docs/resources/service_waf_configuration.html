<html><!-- Online page at https://registry.terraform.io/providers/fastly/fastly/latest/docs/resources/service_waf_configuration --><head>
                <title>service_waf_configuration</title>
                <meta charset="utf-8"/>
                <link href="../../../../../../style.css" rel="stylesheet"/>
            </head>
            <body>
                <aside class="admonition note">
    <strong>note</strong>
    <em>note</em>
    <p>This resource is only available from 0.20.0 of the Fastly terraform provider.</p>
</aside>

<h1 id="fastly_service_waf_configuration">fastly_service_waf_configuration</h1>

<p>Defines a set of Web Application Firewall configuration options that can be used to populate a service WAF. This resource will configure rules, thresholds and other settings for a WAF.</p>

<aside class="admonition warning">
    <strong>warning</strong>
    <em>Warning</em>
    <p>Terraform will take precedence over any changes you make in the UI or API. Such changes are likely to be reversed if you run Terraform again.</p>
</aside>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage"></a><h2 id="example-usage">Example Usage</h2>

<p>Basic usage:</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage with rules:</p>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                          </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1010090</span><span class="w"></span>
<span class="w">    </span><span class="na">revision</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage with rule exclusions:</p>

<aside class="admonition warning">
    <strong>warning</strong>
    <em>Warning</em>
    <p>Rule exclusions are part of a <strong>beta release</strong>, which may be subject to breaking changes and improvements over time. For more information, see our <a href="https://docs.fastly.com/products/fastly-product-lifecycle#beta">product and feature lifecycle</a> descriptions.</p>
</aside>

<div class="codehilite"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2029718</span><span class="w"></span>
<span class="w">    </span><span class="na">revision</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">rule_exclusion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"index page"</span><span class="w"></span>
<span class="w">    </span><span class="na">exclusion_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"rule"</span><span class="w"></span>
<span class="w">    </span><span class="na">condition</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.url.basename == \"index.html\""</span><span class="w"></span>
<span class="w">    </span><span class="na">modsec_rule_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">2029718</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage with rules from data source:</p>

<div class="codehilite"><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">"type_status"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">score</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="w"></span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">    </span><span class="na">strict</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_waf_rules"</span><span class="w"> </span><span class="nv">"owasp"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">publishers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"owasp"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                          </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"rule"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.fastly_waf_rules.owasp.rules</span><span class="w"></span>
<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="w"></span>
<span class="w">      </span><span class="na">revision</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.latest_revision_number</span><span class="w"></span>
<span class="w">      </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.type_status</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.type</span><span class="p">,</span><span class="w"> </span><span class="s2">"log"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage with support for individual rule configuration (this is the suggested pattern):</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># this variable is used for rule configuration in bulk</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"type_status"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">score</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="w"></span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">    </span><span class="na">strict</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>
<span class="c1"># this variable is used for individual rule configuration</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"individual_rules"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">1010020</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"block"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_waf_rules"</span><span class="w"> </span><span class="nv">"owasp"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">publishers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"owasp"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">202</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"rule"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.fastly_waf_rules.owasp.rules</span><span class="w"></span>
<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="w"></span>
<span class="w">      </span><span class="na">revision</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.latest_revision_number</span><span class="c1"></span>
<span class="c1">      # Nested lookups in order to apply a combination of in bulk and individual rule configuration.</span>
<span class="w">      </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.individual_rules</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="p">,</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.type_status</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.type</span><span class="p">,</span><span class="w"> </span><span class="s2">"log"</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage with support for specific rule revision configuration:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># this variable is used for rule configuration in bulk</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"type_status"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">score</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="w"></span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">    </span><span class="na">strict</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># This variable is used for individual rule revision configuration.</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"specific_rule_revisions"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="c1"></span>
<span class="c1">    #  If the revision requested is not found, the server will return a 404 response code.</span>
<span class="w">    </span><span class="na">1010020</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_waf_rules"</span><span class="w"> </span><span class="nv">"owasp"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">publishers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"owasp"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">202</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"rule"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.fastly_waf_rules.owasp.rules</span><span class="w"></span>
<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="w"></span>
<span class="w">      </span><span class="na">revision</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.specific_rule_revisions</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.latest_revision_number</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.type_status</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.type</span><span class="p">,</span><span class="w"> </span><span class="s2">"log"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Usage omitting rule revision field. The first time Terraform is applied, the latest rule revisions are associated with the WAF. Any subsequent apply would not alter the rule revisions.</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># This variable is used for rule configuration in bulk.</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"type_status"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">score</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="w"></span>
<span class="w">    </span><span class="na">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">    </span><span class="na">strict</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"log"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>
<span class="c1"># This variable is used for individual rule configuration.</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">"individual_rules"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">1010020</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"block"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"demo"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demofastly"</span><span class="w"></span>

<span class="w">  </span><span class="nb">domain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">    </span><span class="na">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"demo"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"origin1"</span><span class="w"></span>
<span class="w">    </span><span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"PREFETCH"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"req.backend.is_origin"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="c1"></span>

<span class="c1">  # This condition will always be false</span>
<span class="c1">  # adding it to the response object created below</span>
<span class="c1">  # prevents Fastly from returning a 403 on all of your traffic.</span>
<span class="w">  </span><span class="nb">condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">    </span><span class="na">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"false"</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"REQUEST"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">response_object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">    </span><span class="na">status</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"403"</span><span class="w"></span>
<span class="w">    </span><span class="na">response</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forbidden"</span><span class="w"></span>
<span class="w">    </span><span class="na">content_type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;html&gt;&lt;body&gt;Forbidden&lt;/body&gt;&lt;/html&gt;"</span><span class="w"></span>
<span class="w">    </span><span class="na">request_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_always_false"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">waf</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">prefetch_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Prefetch"</span><span class="w"></span>
<span class="w">    </span><span class="na">response_object</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"WAF_Response"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_waf_rules"</span><span class="w"> </span><span class="nv">"owasp"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">publishers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"owasp"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_waf_configuration"</span><span class="w"> </span><span class="nv">"waf"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">waf_id</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_vcl.demo.waf[0].waf_id</span><span class="w"></span>
<span class="w">  </span><span class="na">http_violation_score_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">202</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"rule"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.fastly_waf_rules.owasp.rules</span><span class="w"></span>
<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">modsec_rule_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="c1"></span>
<span class="c1">      # Rule revision field ommitted.</span>
<span class="w">      </span><span class="na">status</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.individual_rules</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.modsec_rule_id</span><span class="p">,</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.type_status</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.value.type</span><span class="p">,</span><span class="w"> </span><span class="s2">"log"</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>
<span class="c1"># This output contains the WAF's active rules set. This can be useful for identifying which revision is active for each WAF rule.</span>
<span class="kr">output</span><span class="w"> </span><span class="nv">"rules"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_service_waf_configuration.waf.rule</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding%20a%20WAF%20to%20an%20existing%20service"></a><h2 id="adding-a-waf-to-an-existing-service">Adding a WAF to an existing service</h2>

<aside class="admonition warning">
    <strong>warning</strong>
    <em>Warning</em>
    <p>A two-phase change is required when adding a WAF to an existing service</p>
</aside>

<p>When adding a <code>waf</code> to an existing <code>fastly_service_vcl</code> and at the same time adding a <code>fastly_service_waf_configuration</code>
resource with <code>waf_id = fastly_service_vcl.demo.waf[0].waf_id</code> might result with the in the following error:</p>

<blockquote>
  <p>fastly_service_vcl.demo.waf is empty list of object</p>
</blockquote>

<p>For this scenario, it's recommended to split the changes into two distinct steps:</p>

<ol>
<li>Add the <code>waf</code> block to the <code>fastly_service_vcl</code> and apply the changes</li>
<li>Add the <code>fastly_service_waf_configuration</code> to the HCL and apply the changes</li>
</ol>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Import"></a><h2 id="import">Import</h2>

<p>This is an example of the import command being applied to the resource named <code>fastly_service_waf_configuration.waf</code>
The resource ID should be the WAF ID.</p>

<div class="codehilite"><pre><span></span><code>$ terraform import fastly_service_waf_configuration.waf xxxxxxxxxxxxxxxxxxxx
</code></pre></div>

<p>If Terraform is already managing a remote WAF configurations against a resource being imported then the user will be asked to remove it from the existing Terraform state.
The following is an example of the Terraform state command to remove the resource named <code>fastly_service_waf_configuration.waf</code> from the Terraform state file.</p>

<div class="codehilite"><pre><span></span><code>$ terraform state rm fastly_service_waf_configuration.waf
</code></pre></div>

<!-- schema generated by tfplugindocs -->

<a class="dashAnchor" name="//apple_ref/cpp/Section/Schema"></a><h2 id="schema">Schema</h2>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Required"></a><h3 id="required">Required</h3>

<ul>
<li><code>waf_id</code> (String) The ID of the Web Application Firewall that the configuration belongs to</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Optional"></a><h3 id="optional">Optional</h3>

<ul>
<li><code>activate</code> (Boolean) Conditionally prevents a new firewall version from being activated. The apply step will continue to create a new draft version but will not activate it if this is set to <code>false</code>. Default <code>true</code></li>
<li><code>allowed_http_versions</code> (String) Allowed HTTP versions</li>
<li><code>allowed_methods</code> (String) A space-separated list of HTTP method names</li>
<li><code>allowed_request_content_type</code> (String) Allowed request content types</li>
<li><code>allowed_request_content_type_charset</code> (String) Allowed request content type charset</li>
<li><code>arg_length</code> (Number) The maximum number of arguments allowed</li>
<li><code>arg_name_length</code> (Number) The maximum allowed argument name length</li>
<li><code>combined_file_sizes</code> (Number) The maximum allowed size of all files</li>
<li><code>critical_anomaly_score</code> (Number) Score value to add for critical anomalies</li>
<li><code>crs_validate_utf8_encoding</code> (Boolean) CRS validate UTF8 encoding</li>
<li><code>error_anomaly_score</code> (Number) Score value to add for error anomalies</li>
<li><code>high_risk_country_codes</code> (String) A space-separated list of country codes in ISO 3166-1 (two-letter) format</li>
<li><code>http_violation_score_threshold</code> (Number) HTTP violation threshold</li>
<li><code>inbound_anomaly_score_threshold</code> (Number) Inbound anomaly threshold</li>
<li><code>lfi_score_threshold</code> (Number) Local file inclusion attack threshold</li>
<li><code>max_file_size</code> (Number) The maximum allowed file size, in bytes</li>
<li><code>max_num_args</code> (Number) The maximum number of arguments allowed</li>
<li><code>notice_anomaly_score</code> (Number) Score value to add for notice anomalies</li>
<li><code>paranoia_level</code> (Number) The configured paranoia level</li>
<li><code>php_injection_score_threshold</code> (Number) PHP injection threshold</li>
<li><code>rce_score_threshold</code> (Number) Remote code execution threshold</li>
<li><code>restricted_extensions</code> (String) A space-separated list of allowed file extensions</li>
<li><code>restricted_headers</code> (String) A space-separated list of allowed header names</li>
<li><code>rfi_score_threshold</code> (Number) Remote file inclusion attack threshold</li>
<li><code>rule</code> (Block Set) (see <a href="#nestedblock--rule">below for nested schema</a>)</li>
<li><code>rule_exclusion</code> (Block Set) (see <a href="#nestedblock--rule_exclusion">below for nested schema</a>)</li>
<li><code>session_fixation_score_threshold</code> (Number) Session fixation attack threshold</li>
<li><code>sql_injection_score_threshold</code> (Number) SQL injection attack threshold</li>
<li><code>total_arg_length</code> (Number) The maximum size of argument names and values</li>
<li><code>warning_anomaly_score</code> (Number) Score value to add for warning anomalies</li>
<li><code>xss_score_threshold</code> (Number) XSS attack threshold</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Read-Only"></a><h3 id="read-only">Read-Only</h3>

<ul>
<li><code>active</code> (Boolean) Whether a specific firewall version is currently deployed</li>
<li><code>cloned_version</code> (Number) The latest cloned firewall version by the provider</li>
<li><code>id</code> (String) The ID of this resource.</li>
<li><code>number</code> (Number) The WAF firewall version</li>
</ul>

<p><a id="nestedblock--rule"></a></p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Nested%20Schema%20for%20rule"></a><h3 id="nested-schema-for-rule">Nested Schema for <code>rule</code></h3>

<p>Required:</p>

<ul>
<li><code>modsec_rule_id</code> (Number) The Web Application Firewall rule's modsecurity ID</li>
<li><code>status</code> (String) The Web Application Firewall rule's status. Allowed values are (<code>log</code>, <code>block</code> and <code>score</code>)</li>
</ul>

<p>Optional:</p>

<ul>
<li><code>revision</code> (Number) The Web Application Firewall rule's revision. The latest revision will be used if this is not provided</li>
</ul>

<p><a id="nestedblock--rule_exclusion"></a></p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Nested%20Schema%20for%20rule_exclusion"></a><h3 id="nested-schema-for-rule_exclusion">Nested Schema for <code>rule_exclusion</code></h3>

<p>Required:</p>

<ul>
<li><code>condition</code> (String) A conditional expression in VCL used to determine if the condition is met</li>
<li><code>exclusion_type</code> (String) The type of rule exclusion. Values are <code>rule</code> to exclude the specified rule(s), or <code>waf</code> to disable the Web Application Firewall</li>
<li><code>name</code> (String) The name of rule exclusion</li>
</ul>

<p>Optional:</p>

<ul>
<li><code>modsec_rule_ids</code> (Set of Number) Set of modsecurity IDs to be excluded. No rules should be provided when <code>exclusion_type</code> is <code>waf</code>. The rules need to be configured on the Web Application Firewall to be excluded</li>
</ul>

<p>Read-Only:</p>

<ul>
<li><code>number</code> (Number) The numeric ID assigned to the WAF Rule Exclusion</li>
</ul>

            
        
    </body></html>