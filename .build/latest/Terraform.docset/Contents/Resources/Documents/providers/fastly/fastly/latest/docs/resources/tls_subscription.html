<html><!-- Online page at https://registry.terraform.io/providers/fastly/fastly/latest/docs/resources/tls_subscription --><head>
                <title>tls_subscription</title>
                <meta charset="utf-8"/>
                <link href="../../../../../../style.css" rel="stylesheet"/>
            </head>
            <body>
                <h1 id="fastly_tls_subscription">fastly_tls_subscription</h1>

<p>Enables TLS on a domain using a certificate managed by Fastly.</p>

<p>DNS records need to be modified on the domain being secured, in order to respond to the ACME domain ownership challenge.</p>

<p>There are two options for doing this: the <code>managed_dns_challenges</code>, which is the default method; and the <code>managed_http_challenges</code>, which points production traffic to Fastly.</p>

<aside class="admonition warning">
    <strong>warning</strong>
    <em>warning</em>
    <p>See the <a href="https://docs.fastly.com/en/guides/serving-https-traffic-using-fastly-managed-certificates#verifying-domain-ownership">Fastly documentation</a> for more information on verifying domain ownership.</p>
</aside>

<p>The examples below demonstrate usage with AWS Route53 to configure DNS, and the <code>fastly_tls_subscription_validation</code> resource to wait for validation to complete.</p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Example%20Usage"></a><h2 id="example-usage">Example Usage</h2>

<p><strong>Basic usage:</strong></p>

<p>The following example demonstrates how to configured two subdomains (e.g. <code>a.example.com</code>, <code>b.example.com</code>).</p>

<p>The workflow configures a <code>fastly_tls_subscription</code> resource, then a <code>aws_route53_record</code> resource for handling the creation of the 'challenge' DNS records (e.g. <code>_acme-challenge.a.example.com</code> and <code>_acme-challenge.b.example.com</code>).</p>

<p>We configure the <code>fastly_tls_subscription_validation</code> resource, which blocks other resources until the challenge DNS records have been validated by Fastly.</p>

<p>Once the validation has been successful, the configured <code>fastly_tls_configuration</code> data source will filter the available results looking for an appropriate TLS configuration object. If that filtering process is successful, then the subsequent <code>aws_route53_record</code> resources (for configuring the subdomains) will be executed using the returned TLS configuration data.</p>

<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"hashicorp/aws"</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4.55.0"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">fastly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"fastly/fastly"</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"3.1.0"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># NOTE: Creating a hosted zone will automatically create SOA/NS records.</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_zone"</span><span class="w"> </span><span class="nv">"production"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53domains_registered_domain"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">domain_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"name_server"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.name_servers</span><span class="w"></span>

<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">name_server.value</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">subdomains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"a.example.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"b.example.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example-service"</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"domain"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.subdomains</span><span class="w"></span>

<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">domain.value</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"localhost"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_tls_subscription"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">domains</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">domain</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_service_vcl.example.domain</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">domain.name</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">certificate_authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lets-encrypt"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_record"</span><span class="w"> </span><span class="nv">"domain_validation"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">fastly_tls_subscription.example</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="nb">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="c1"></span>
<span class="c1">    # The following `for` expression (due to the outer {}) will produce an object with key/value pairs.</span>
<span class="c1">    # The 'key' is the domain name we've configured (e.g. a.example.com, b.example.com)</span>
<span class="c1">    # The 'value' is a specific 'challenge' object whose record_name matches the domain (e.g. record_name is _acme-challenge.a.example.com).</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">domain</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.domains</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="na">domain</span><span class="w"> </span><span class="o">=</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">element</span><span class="p">([</span><span class="w"></span>
<span class="w">      </span><span class="err">for</span><span class="w"> </span><span class="err">obj</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.managed_dns_challenges</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="err">obj</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">obj.record_name</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">"_acme-challenge.${domain}"</span><span class="c1"> # We use an `if` conditional to filter the list to a single element</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="c1">                                                   # `element()` returns the first object in the list which should be the relevant 'challenge' object we need</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.record_name</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.record_type</span><span class="w"></span>
<span class="w">  </span><span class="na">zone_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.zone_id</span><span class="w"></span>
<span class="w">  </span><span class="na">allow_overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">  </span><span class="na">records</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">each.value.record_value</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">ttl</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># This is a resource that other resources can depend on if they require the certificate to be issued.</span>
<span class="c1"># NOTE: Internally the resource keeps retrying `GetTLSSubscription` until no error is returned (or the configured timeout is reached).</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_tls_subscription_validation"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">subscription_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.id</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_route53_record.domain_validation</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># This data source lists all available configuration objects.</span>
<span class="c1"># It uses a `default` attribute to narrow down the list to just one configuration object.</span>
<span class="c1"># If the filtered list has a length that is not exactly one element, you'll see an error returned.</span>
<span class="c1"># The single TLS configuration is then returned and can be referenced by other resources (see aws_route53_record below).</span>
<span class="c1">#</span>
<span class="c1"># IMPORTANT: Not all customers will have a 'default' configuration.</span>
<span class="c1"># If you have issues filtering with `default = true`, then you may need another attribute.</span>
<span class="c1"># Refer to the fastly_tls_configuration documentation for available attributes:</span>
<span class="c1"># https://registry.terraform.io/providers/fastly/fastly/latest/docs/data-sources/tls_configuration#optional</span>
<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_tls_configuration"</span><span class="w"> </span><span class="nv">"default_tls"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">fastly_tls_subscription_validation.example</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># Once validation is complete and we've retrieved the TLS configuration data, we can create multiple subdomain records.</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_record"</span><span class="w"> </span><span class="nv">"subdomain"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nv">local.subdomains</span><span class="p">)</span><span class="c1"> # Because `subdomains` is ultimately a list, the `each` variable produced will contain only a `value` property which will be the subdomain.</span>

<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value</span><span class="c1"> # e.g. a.example.com, b.example.com</span>
<span class="w">  </span><span class="na">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">record</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">data.fastly_tls_configuration.default_tls.dns_records</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">record.record_value</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">record.record_type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">ttl</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="w"></span>
<span class="w">  </span><span class="na">zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.zone_id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p><strong>Configuring an apex and a wildcard domain:</strong></p>

<p>The following example is similar to the above but differs by demonstrating how to handle configuring an apex domain (e.g. <code>example.com</code>) and a wildcard domain (e.g. <code>*.example.com</code>) so you can support multiple subdomains to your service.</p>

<p>The difference in the workflow is with how to handle the Fastly API returning a single 'challenge' for both domains (e.g. <code>_acme-challenge.example.com</code>). This is done by normalising the wildcard (i.e. replacing <code>*.example.com</code> with <code>example.com</code>) and then working around the issue of the returned object having two identical keys.</p>

<div class="codehilite"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"hashicorp/aws"</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4.55.0"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">fastly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"fastly/fastly"</span><span class="w"></span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"3.1.0"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># NOTE: Creating a hosted zone will automatically create SOA/NS records.</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_zone"</span><span class="w"> </span><span class="nv">"production"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53domains_registered_domain"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">domain_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"name_server"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.name_servers</span><span class="w"></span>

<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">name_server.value</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"example.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"*.example.com"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_service_vcl"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"example-service"</span><span class="w"></span>

<span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">"domain"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.domains</span><span class="w"></span>

<span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">domain.value</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">backend</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"localhost"</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">force_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_tls_subscription"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">domains</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">domain</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_service_vcl.example.domain</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">domain.name</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">certificate_authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lets-encrypt"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_record"</span><span class="w"> </span><span class="nv">"domain_validation"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">fastly_tls_subscription.example</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="nb">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="c1"></span>
<span class="c1">    # The following `for` expression (due to the outer {}) will produce an object with key/value pairs.</span>
<span class="c1">    # In this example we are defining an apex (example.com) and a wildcard (*.example.com) which causes the API to return a single challenge (e.g. _acme-challenge.example.com)</span>
<span class="c1">    # To ensure we can match the single challenge for both domains we need to normalise the wildcard domain.</span>
<span class="c1">    # The 'key' is the normalised domain name (e.g. example.com)</span>
<span class="c1">    # The 'value' is the single 'challenge' object whose record_name matches the normalised version of the domain (e.g. record_name is _acme-challenge.example.com).</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">domain</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.domains</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nf">replace</span><span class="p">(</span><span class="err">domain</span><span class="p">,</span><span class="w"> </span><span class="s2">"*.", ""</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">element</span><span class="p">([</span><span class="w"></span>
<span class="w">      </span><span class="err">for</span><span class="w"> </span><span class="err">obj</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.managed_dns_challenges</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="err">obj</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">obj.record_name</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">"_acme-challenge.${replace(domain, "*.", "")}"</span><span class="c1"> # We use an `if` conditional to filter the list to a single element</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="m">0</span><span class="p">)...</span><span class="c1">                                                                   # `element()` returns the first object in the list which should be the relevant 'challenge' object we need</span>
<span class="c1">    # The ellipsis ... avoids Terraform complaining that the resulting object will contain multiple keys that are duplicates (e.g. multiple 'example.com' keys).</span>
<span class="c1">    # It essentially groups the 'values' (the single challenge) under the common key (the normalised domain).</span>
<span class="c1">    # Then below we extract the first value (as they'll all be the same 'challenge' value).</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value[0].record_name</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value[0].record_type</span><span class="w"></span>
<span class="w">  </span><span class="na">zone_id</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.zone_id</span><span class="w"></span>
<span class="w">  </span><span class="na">allow_overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">  </span><span class="na">records</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">each.value[0].record_value</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">ttl</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># This is a resource that other resources can depend on if they require the certificate to be issued.</span>
<span class="c1"># NOTE: Internally the resource keeps retrying `GetTLSSubscription` until no error is returned (or the configured timeout is reached).</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"fastly_tls_subscription_validation"</span><span class="w"> </span><span class="nv">"example"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">subscription_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fastly_tls_subscription.example.id</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_route53_record.domain_validation</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># This data source lists all available configuration objects.</span>
<span class="c1"># It uses a `default` attribute to narrow down the list to just one configuration object.</span>
<span class="c1"># If the filtered list has a length that is not exactly one element, you'll see an error returned.</span>
<span class="c1"># The single TLS configuration is then returned and can be referenced by other resources (see aws_route53_record below).</span>
<span class="c1">#</span>
<span class="c1"># IMPORTANT: Not all customers will have a 'default' configuration.</span>
<span class="c1"># If you have issues filtering with `default = true`, then you may need another attribute.</span>
<span class="c1"># Refer to the fastly_tls_configuration documentation for available attributes:</span>
<span class="c1"># https://registry.terraform.io/providers/fastly/fastly/latest/docs/data-sources/tls_configuration#optional</span>
<span class="kr">data</span><span class="w"> </span><span class="nc">"fastly_tls_configuration"</span><span class="w"> </span><span class="nv">"default_tls"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"></span>
<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">fastly_tls_subscription_validation.example</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># Once validation is complete and we've retrieved the TLS configuration data, we can create multiple records...</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_record"</span><span class="w"> </span><span class="nv">"apex"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"example.com"</span><span class="w"></span>
<span class="w">  </span><span class="na">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">record</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">data.fastly_tls_configuration.default_tls.dns_records</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">record.record_value</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">record.record_type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">"A"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">ttl</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"A"</span><span class="w"></span>
<span class="w">  </span><span class="na">zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.zone_id</span><span class="w"></span>
<span class="p">}</span><span class="c1"></span>

<span class="c1"># NOTE: This subdomain matches our Fastly service because of the wildcard domain (`*.example.com`) that was added to the service.</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_route53_record"</span><span class="w"> </span><span class="nv">"subdomain"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"test.example.com"</span><span class="w"></span>
<span class="w">  </span><span class="na">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">record</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">data.fastly_tls_configuration.default_tls.dns_records</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">record.record_value</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">record.record_type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">ttl</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="w"></span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="w"></span>
<span class="w">  </span><span class="na">zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_route53_zone.production.zone_id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Argument%20Reference"></a><h2 id="argument-reference">Argument Reference</h2>

<p>The following arguments are supported:</p>

<ul>
<li><code>domains</code> - (Required) List of domains on which to enable TLS.</li>
<li><code>certificate_authority</code> - (Required) The entity that issues and certifies the TLS certificates for your subscription. Valid values are <code>lets-encrypt</code> or <code>globalsign</code>.</li>
<li><code>configuration_id</code> - (Optional) The ID of the set of TLS configuration options that apply to the enabled domains on this subscription.</li>
<li><code>force_update</code> - (Optional) Always update subscription, even when active domains are present. Defaults to false.</li>
<li><code>force_destroy</code> - (Optional) Always delete subscription, even when active domains are present. Defaults to false.</li>
</ul>

<aside class="admonition danger">
    <strong>danger</strong>
    <em>Warning</em>
    <p>by default, the Fastly API protects you from disabling production traffic by preventing updating or deleting subscriptions with active domains. The use of <code>force_update</code> and <code>force_destroy</code> will override these protections. Take extra care using these options if you are handling production traffic.</p>
</aside>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Attributes%20Reference"></a><h2 id="attributes-reference">Attributes Reference</h2>

<p>In addition to the arguments listed above, the following attributes are exported:</p>

<ul>
<li><code>created_at</code> - Timestamp (GMT) when the subscription was created.</li>
<li><code>updated_at</code> - Timestamp (GMT) when the subscription was last updated.</li>
<li><code>state</code> - The current state of the subscription. The list of possible states are: <code>pending</code>, <code>processing</code>, <code>issued</code>, and <code>renewing</code>.</li>
<li><code>managed_dns_challenges</code> - A list of options for configuring DNS to respond to ACME DNS challenge in order to verify domain ownership. See Managed DNS Challenge below for details.</li>
<li><code>managed_http_challenges</code> - A list of options for configuring DNS to respond to ACME HTTP challenge in order to verify domain ownership. See Managed HTTP Challenges below for details.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Managed%20DNS%20Challenge"></a><h3 id="managed-dns-challenge">Managed DNS Challenge</h3>

<p>The available attributes in the <code>managed_dns_challenges</code> block are:</p>

<ul>
<li><code>record_name</code> - The name of the DNS record to add. For example <code>_acme-challenge.example.com</code>. Accessed like this, <code>fastly_tls_subscription.tls.managed_dns_challenges.record_name</code>.</li>
<li><code>record_type</code> - The type of DNS record to add, e.g. <code>A</code>, or <code>CNAME</code>.</li>
<li><code>record_value</code> - The value to which the DNS record should point, e.g. <code>xxxxx.fastly-validations.com</code>.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Managed%20HTTP%20Challenges"></a><h3 id="managed-http-challenges">Managed HTTP Challenges</h3>

<p>The <code>managed_http_challenges</code> attribute is a set of different records that could be added depending on requirements.
For example, whether you are adding TLS to an apex domain, or a subdomain will determine which record you require.
Please note that these records will redirect production traffic to Fastly, so make sure the service is configured correctly first.
Each record in the set has the following attributes:</p>

<ul>
<li><code>record_name</code> - The name of the DNS record to add. For example <code>example.com</code>. Best accessed through a <code>for</code> expression to filter the relevant record.</li>
<li><code>record_type</code> - The type of DNS record to add, e.g. <code>A</code>, or <code>CNAME</code>.</li>
<li><code>record_values</code> - A list with the value(s) to which the DNS record should point.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Import"></a><h2 id="import">Import</h2>

<p>A subscription can be imported using its Fastly subscription ID, e.g.</p>

<div class="codehilite"><pre><span></span><code>$ terraform import fastly_tls_subscription.demo xxxxxxxxxxx
</code></pre></div>

<!-- schema generated by tfplugindocs -->

<a class="dashAnchor" name="//apple_ref/cpp/Section/Schema"></a><h2 id="schema">Schema</h2>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Required"></a><h3 id="required">Required</h3>

<ul>
<li><code>certificate_authority</code> (String) The entity that issues and certifies the TLS certificates for your subscription. Valid values are <code>lets-encrypt</code>, <code>globalsign</code> or <code>certainly</code>.</li>
<li><code>domains</code> (Set of String) List of domains on which to enable TLS.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Optional"></a><h3 id="optional">Optional</h3>

<ul>
<li><code>common_name</code> (String) The common name associated with the subscription generated by Fastly TLS. If you do not pass a common name on create, we will default to the first TLS domain included. If provided, the domain chosen as the common name must be included in TLS domains.</li>
<li><code>configuration_id</code> (String) The ID of the set of TLS configuration options that apply to the enabled domains on this subscription.</li>
<li><code>force_destroy</code> (Boolean) Force delete the subscription even if it has active domains. Warning: this can disable production traffic if used incorrectly. Defaults to false.</li>
<li><code>force_update</code> (Boolean) Force update the subscription even if it has active domains. Warning: this can disable production traffic if used incorrectly.</li>
</ul>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Read-Only"></a><h3 id="read-only">Read-Only</h3>

<ul>
<li><code>certificate_id</code> (String) The certificate ID associated with the subscription.</li>
<li><code>created_at</code> (String) Timestamp (GMT) when the subscription was created.</li>
<li><code>id</code> (String) The ID of this resource.</li>
<li><code>managed_dns_challenge</code> (Map of String, Deprecated) The details required to configure DNS to respond to ACME DNS challenge in order to verify domain ownership.</li>
<li><code>managed_dns_challenges</code> (Set of Object) A list of options for configuring DNS to respond to ACME DNS challenge in order to verify domain ownership. (see <a href="#nestedatt--managed_dns_challenges">below for nested schema</a>)</li>
<li><code>managed_http_challenges</code> (Set of Object) A list of options for configuring DNS to respond to ACME HTTP challenge in order to verify domain ownership. Best accessed through a <code>for</code> expression to filter the relevant record. (see <a href="#nestedatt--managed_http_challenges">below for nested schema</a>)</li>
<li><code>state</code> (String) The current state of the subscription. The list of possible states are: <code>pending</code>, <code>processing</code>, <code>issued</code>, and <code>renewing</code>.</li>
<li><code>updated_at</code> (String) Timestamp (GMT) when the subscription was updated.</li>
</ul>

<p><a id="nestedatt--managed_dns_challenges"></a></p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Nested%20Schema%20for%20managed_dns_challenges"></a><h3 id="nested-schema-for-managed_dns_challenges">Nested Schema for <code>managed_dns_challenges</code></h3>

<p>Read-Only:</p>

<ul>
<li><code>record_name</code> (String)</li>
<li><code>record_type</code> (String)</li>
<li><code>record_value</code> (String)</li>
</ul>

<p><a id="nestedatt--managed_http_challenges"></a></p>

<a class="dashAnchor" name="//apple_ref/cpp/Section/Nested%20Schema%20for%20managed_http_challenges"></a><h3 id="nested-schema-for-managed_http_challenges">Nested Schema for <code>managed_http_challenges</code></h3>

<p>Read-Only:</p>

<ul>
<li><code>record_name</code> (String)</li>
<li><code>record_type</code> (String)</li>
<li><code>record_values</code> (Set of String)</li>
</ul>

            
        
    </body></html>